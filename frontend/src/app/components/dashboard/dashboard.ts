import { CommonModule } from '@angular/common';
import { Component } from '@angular/core';
import { FormControl, ReactiveFormsModule } from '@angular/forms';
import { MatSnackBar } from '@angular/material/snack-bar';
import {
  ConversionRequest,
  ConversionResponse,
  DivisasService,
} from '../../services/divisas';
import { MaterialModule } from '../../shared/material.module';

@Component({
  selector: 'app-dashboard',
  imports: [CommonModule, MaterialModule, ReactiveFormsModule],
  templateUrl: './dashboard.html',
  styleUrl: './dashboard.scss',
})
export class Dashboard {
  resultado: any = null;
  cargando = false;

  // Form Controls
  cantidad = new FormControl(100);
  monedaOrigen = new FormControl('USD');
  monedaDestino = new FormControl('EUR');

  // PROPIEDADES PARA LA TABLA
  tiposCambio: any[] = [];
  cargandoTabla = false;
  monedaBase = new FormControl('USD');
  ultimaActualizacion: string = '';

  // Lista de divisas disponibles
  divisas = [
    { code: 'USD', name: 'D√≥lar Estadounidense', flag: 'üá∫üá∏' },
    { code: 'EUR', name: 'Euro', flag: 'üá™üá∫' },
    { code: 'GBP', name: 'Libra Esterlina', flag: 'üá¨üáß' },
    { code: 'JPY', name: 'Yen Japon√©s', flag: 'üáØüáµ' },
    { code: 'CHF', name: 'Franco Suizo', flag: 'üá®üá≠' },
    { code: 'CAD', name: 'D√≥lar Canadiense', flag: 'üá®üá¶' },
    { code: 'AUD', name: 'D√≥lar Australiano', flag: 'üá¶üá∫' },
    { code: 'CNY', name: 'Yuan Chino', flag: 'üá®üá≥' },
    { code: 'MXN', name: 'Peso Mexicano', flag: 'üá≤üáΩ' },
    { code: 'BRL', name: 'Real Brasile√±o', flag: 'üáßüá∑' },
    { code: 'KRW', name: 'Won Surcoreano', flag: 'üá∞üá∑' },
    { code: 'INR', name: 'Rupia India', flag: 'üáÆüá≥' },
    { code: 'SEK', name: 'Corona Sueca', flag: 'üá∏üá™' },
    { code: 'NOK', name: 'Corona Noruega', flag: 'üá≥üá¥' },
    { code: 'HKD', name: 'D√≥lar de Hong Kong', flag: 'üá≠üá∞' },
    { code: 'SGD', name: 'D√≥lar de Singapur', flag: 'üá∏üá¨' },
    { code: 'NZD', name: 'D√≥lar Neozeland√©s', flag: 'üá≥üáø' },
    { code: 'ZAR', name: 'Rand Sudafricano', flag: 'üáøüá¶' },
    { code: 'TRY', name: 'Lira Turca', flag: 'üáπüá∑' },
    { code: 'PLN', name: 'Zloty Polaco', flag: 'üáµüá±' },
  ]; // ‚úÖ Ahora 14 divisas (igual que historial)

  constructor(
    private divisasService: DivisasService,
    private snackBar: MatSnackBar // ‚úÖ A√ëADIR
  ) {
    this.cargarTiposCambio();
  }

  // M√âTODO ACTUALIZADO PARA CARGAR TIPOS DE CAMBIO
  cargarTiposCambio(): void {
    const base = this.monedaBase.value || 'USD';
    this.cargandoTabla = true;

    // Usar m√©todo del servicio conectado a tu backend
    this.divisasService.getExchangeRates(base).subscribe({
      next: (response: any) => {
        console.log('‚úÖ Datos del backend:', response);
        this.procesarTiposCambioBackend(response, base);
        this.cargandoTabla = false;
      },
      error: (error: any) => {
        console.error('‚ùå Error con backend, usando Frankfurter:', error);
        // Fallback a Frankfurter si falla el backend
        this.cargarTiposCambioFallback(base);
      },
    });
  }

  // PROCESAR datos de tu backend Node.js
  procesarTiposCambioBackend(response: any, base: string): void {
    console.log('üîç Response completo del backend:', response);
    console.log('üîç Rates disponibles:', Object.keys(response.rates || {}));

    this.ultimaActualizacion = response.date || new Date().toLocaleDateString();
    this.tiposCambio = [];

    if (response.rates) {
      Object.keys(response.rates).forEach((currency) => {
        const divisa = this.divisas.find((d) => d.code === currency);

        if (divisa) {
          console.log(`‚úÖ A√±adiendo ${currency}: ${response.rates[currency]}`);
          this.tiposCambio.push({
            code: currency,
            name: divisa ? divisa.name : this.getCurrencyName(currency),
            flag: divisa ? divisa.flag : this.getCurrencyFlag(currency),
            rate: response.rates[currency],
            base: response.base || base,
          });
        } else {
          console.log(`‚ùå Divisa ${currency} no encontrada en array local`);
        }
      });
    }

    console.log('üîç Final tiposCambio array:', this.tiposCambio);
    this.tiposCambio.sort((a, b) => a.code.localeCompare(b.code));
  }

  // FALLBACK con Frankfurter
  cargarTiposCambioFallback(base: string): void {
    this.divisasService.getLatestRatesFromFrankfurter(base).subscribe({
      next: (response: any) => {
        console.log('‚úÖ Datos de Frankfurter:', response);
        this.procesarTiposCambioFrankfurter(response);
        this.cargandoTabla = false;
      },
      error: (error: any) => {
        console.error('‚ùå Error total:', error);
        this.cargandoTabla = false;
      },
    });
  }

  // PROCESAR datos de Frankfurter (fallback)
  procesarTiposCambioFrankfurter(response: any): void {
    this.ultimaActualizacion = response.date || new Date().toLocaleDateString();
    this.tiposCambio = [];

    if (response.rates) {
      Object.keys(response.rates).forEach((currency) => {
        const divisa = this.divisas.find((d) => d.code === currency);
        if (divisa) {
          this.tiposCambio.push({
            code: currency,
            name: divisa.name,
            flag: divisa.flag,
            rate: response.rates[currency],
            base: response.base,
          });
        }
      });
    }

    this.tiposCambio.sort((a, b) => a.code.localeCompare(b.code));
  }

  cambiarMonedaBase(): void {
    this.cargarTiposCambio();
  }

  // M√âTODO ACTUALIZADO PARA CONVERSI√ìN
  convertirDivisas(): void {
    const cantidad = this.cantidad.value || 0;
    const origen = this.monedaOrigen.value || 'USD';
    const destino = this.monedaDestino.value || 'EUR';

    if (cantidad <= 0) {
      return;
    }

    this.cargando = true;

    // USAR INTERFAZ CORRECTA DE TU BACKEND
    const request: ConversionRequest = {
      from: origen, // ‚úÖ Tu backend usa 'from'
      to: destino, // ‚úÖ Tu backend usa 'to'
      amount: cantidad, // ‚úÖ Tu backend usa 'amount'
    };

    // Intentar con tu backend Node.js primero
    this.divisasService.convertCurrency(request).subscribe({
      next: (response: ConversionResponse) => {
        console.log('‚úÖ Conversi√≥n desde tu backend:', response);
        this.resultado = {
          amount: response.amount,
          result: response.result,
          from: response.from,
          to: response.to,
          rate: response.rate,
          date: response.date,
        };
        this.cargando = false;
      },
      error: (error: any) => {
        console.error('‚ùå Error en tu backend, usando Frankfurter:', error);
        // Fallback a Frankfurter
        this.convertirConFrankfurter(cantidad, origen, destino);
      },
    });
  }

  // FALLBACK para conversi√≥n
  convertirConFrankfurter(
    cantidad: number,
    origen: string,
    destino: string
  ): void {
    this.divisasService
      .convertWithFrankfurter(origen, destino, cantidad)
      .subscribe({
        next: (response: any) => {
          console.log('‚úÖ Conversi√≥n con Frankfurter:', response);
          this.resultado = {
            amount: cantidad,
            result: response.rates[destino],
            from: origen,
            to: destino,
            rate: response.rates[destino] / cantidad,
            date: response.date,
          };
          this.cargando = false;
        },
        error: (error: any) => {
          console.error('‚ùå Error total en conversi√≥n:', error);
          this.cargando = false;
        },
      });
  }

  intercambiarDivisas(): void {
    const temp = this.monedaOrigen.value;
    this.monedaOrigen.setValue(this.monedaDestino.value);
    this.monedaDestino.setValue(temp);

    if (this.cantidad.value && this.cantidad.value > 0) {
      this.convertirDivisas();
    }
  }

  probarConversion(): void {
    this.convertirDivisas();
  }

  usarEnConversor(codigoDivisa: string): void {
    this.monedaDestino.setValue(codigoDivisa);

    if (this.cantidad.value && this.cantidad.value > 0) {
      this.convertirDivisas();
    }
  }

  // NUEVO: M√©todo convert() con validaciones
  convert(): void {
    // ‚úÖ VALIDACI√ìN: Misma divisa (CORREGIR)
    if (this.monedaOrigen.value === this.monedaDestino.value) {
      this.snackBar.open(
        '‚ùå Las divisas origen y destino deben ser diferentes',
        'Cerrar',
        {
          duration: 4000,
          panelClass: ['error-snackbar'],
        }
      );
      return;
    }

    // ‚úÖ VALIDACI√ìN: Cantidad v√°lida (CORREGIR)
    if (!this.cantidad.value || this.cantidad.value <= 0) {
      this.snackBar.open('‚ùå Ingresa una cantidad v√°lida', 'Cerrar', {
        duration: 3000,
      });
      return;
    }

    // ‚úÖ VALIDACI√ìN: Divisas seleccionadas (A√ëADIR)
    if (!this.monedaOrigen.value || !this.monedaDestino.value) {
      this.snackBar.open('‚ùå Selecciona ambas divisas', 'Cerrar', {
        duration: 3000,
      });
      return;
    }

    this.cargando = true;

    // ‚úÖ CORREGIR request con validaci√≥n de null:
    const request: ConversionRequest = {
      from: this.monedaOrigen.value!, // ‚úÖ Usar ! para indicar que no es null
      to: this.monedaDestino.value!, // ‚úÖ Usar ! para indicar que no es null
      amount: this.cantidad.value!, // ‚úÖ Usar ! para indicar que no es null
    };

    this.divisasService.convertCurrency(request).subscribe({
      next: (response: ConversionResponse) => {
        console.log('‚úÖ Conversi√≥n desde tu backend:', response);
        this.resultado = {
          amount: response.amount,
          result: response.result,
          from: response.from,
          to: response.to,
          rate: response.rate,
          date: response.date,
        };
        this.cargando = false;
      },
      error: (error: any) => {
        console.error('‚ùå Error en tu conversi√≥n:', error);
        this.cargando = false;

        let errorMessage = 'Error en la conversi√≥n. Int√©ntalo de nuevo.';

        if (error.status === 422) {
          errorMessage = 'Las divisas origen y destino no pueden ser iguales.';
        } else if (error.status === 404) {
          errorMessage = 'Divisa no encontrada.';
        } else if (error.status === 0) {
          errorMessage = 'Error de conexi√≥n. Verifica tu internet.';
        }

        this.snackBar.open(`‚ùå ${errorMessage}`, 'Cerrar', {
          duration: 5000,
          panelClass: ['error-snackbar'],
        });
      },
    });
  }

  // ‚úÖ FILTRAR divisas para origen (excluir la seleccionada en destino)
  getDivisasOrigen() {
    return this.divisas.filter(
      (divisa) => divisa.code !== this.monedaDestino.value
    );
  }

  // ‚úÖ FILTRAR divisas para destino (excluir la seleccionada en origen)
  getDivisasDestino() {
    return this.divisas.filter(
      (divisa) => divisa.code !== this.monedaOrigen.value
    );
  }

  // ‚úÖ EVENTO cuando cambia divisa origen
  onMonedaOrigenChange(): void {
    // Si la divisa destino es igual a la origen, resetear destino
    if (this.monedaDestino.value === this.monedaOrigen.value) {
      this.monedaDestino.setValue('');
    }
  }

  // ‚úÖ EVENTO cuando cambia divisa destino
  onMonedaDestinoChange(): void {
    // Si la divisa origen es igual a la destino, resetear origen
    if (this.monedaOrigen.value === this.monedaDestino.value) {
      this.monedaOrigen.setValue('');
    }
  }

  // ‚úÖ A√ëADIR funciones helper al final de la clase:

  getCurrencyName(code: string): string {
    const names: { [key: string]: string } = {
      AUD: 'D√≥lar Australiano',
      BGN: 'Lev B√∫lgaro',
      BRL: 'Real Brasile√±o',
      CAD: 'D√≥lar Canadiense',
      CHF: 'Franco Suizo',
      CNY: 'Yuan Chino',
      CZK: 'Corona Checa',
      DKK: 'Corona Danesa',
      EUR: 'Euro',
      GBP: 'Libra Esterlina',
      HKD: 'D√≥lar de Hong Kong',
      HUF: 'Forint H√∫ngaro',
      IDR: 'Rupia Indonesia',
      ILS: 'Shekel Israel√≠',
      INR: 'Rupia India',
      ISK: 'Corona Islandesa',
      JPY: 'Yen Japon√©s',
      KRW: 'Won Surcoreano',
      MXN: 'Peso Mexicano',
      MYR: 'Ringgit Malayo',
      NOK: 'Corona Noruega',
      NZD: 'D√≥lar Neozeland√©s',
      PHP: 'Peso Filipino',
      PLN: 'Zloty Polaco',
      RON: 'Leu Rumano',
      SEK: 'Corona Sueca',
      SGD: 'D√≥lar de Singapur',
      THB: 'Baht Tailand√©s',
      TRY: 'Lira Turca',
      USD: 'D√≥lar Estadounidense',
      ZAR: 'Rand Sudafricano',
    };
    return names[code] || code;
  }

  getCurrencyFlag(code: string): string {
    const flags: { [key: string]: string } = {
      AUD: 'üá¶üá∫',
      BGN: 'üáßüá¨',
      BRL: 'üáßüá∑',
      CAD: 'üá®üá¶',
      CHF: 'üá®üá≠',
      CNY: 'üá®üá≥',
      CZK: 'üá®üáø',
      DKK: 'üá©üá∞',
      EUR: 'üá™üá∫',
      GBP: 'üá¨üáß',
      HKD: 'üá≠üá∞',
      HUF: 'üá≠üá∫',
      IDR: 'üáÆüá©',
      ILS: 'üáÆüá±',
      INR: 'üáÆüá≥',
      ISK: 'üáÆüá∏',
      JPY: 'üáØüáµ',
      KRW: 'üá∞üá∑',
      MXN: 'üá≤üáΩ',
      MYR: 'üá≤üáæ',
      NOK: 'üá≥üá¥',
      NZD: 'üá≥üáø',
      PHP: 'üáµüá≠',
      PLN: 'üáµüá±',
      RON: 'üá∑üá¥',
      SEK: 'üá∏üá™',
      SGD: 'üá∏üá¨',
      THB: 'üáπüá≠',
      TRY: 'üáπüá∑',
      USD: 'üá∫üá∏',
      ZAR: 'üáøüá¶',
    };
    return flags[code] || 'üåç';
  }
}
