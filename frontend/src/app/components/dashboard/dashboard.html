<div class="dashboard-container">
  <!-- Header con t√≠tulo -->
  <div class="dashboard-header">
    <div class="header-content">
      <div class="header-info">
        <div class="header-text">
          <h1>Dashboard</h1>
          <p>{{ isAuthenticated ? 'Suite Profesional de Trading de Divisas' : 'Plataforma L√≠der en Conversi√≥n de Divisas ‚Ä¢ √önete Gratis' }}</p>
        </div>
      </div>
      <div class="header-stats" *ngIf="isAuthenticated && userStats">
        <div class="stat-item">
          <span class="stat-number">{{ userStats.totalConversions || 0 }}</span>
          <span class="stat-label">Conversiones</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">{{ userStats.totalAlerts || 0 }}</span>
          <span class="stat-label">Alertas</span>
        </div>
      </div>
    </div>
  </div>

  <div class="content-wrapper">

    <!-- üÜï BANNER DE INFORMACI√ìN PARA USUARIOS NO AUTENTICADOS -->
    <mat-card class="limited-mode-banner" *ngIf="isLimitedMode">
      <mat-card-content>
        <div class="banner-content">
          <div class="banner-icon">
            <mat-icon>info</mat-icon>
          </div>
          <div class="banner-text">
            <h3>Modo de Prueba Activado</h3>
            <p>Est√°s usando DivisasPro en modo limitado. Puedes convertir entre las 8 divisas principales con USD como base.</p>
            <ul class="limitations-list">
              <li>‚Ä¢ Solo 8 divisas principales disponibles ---- ‚Ä¢ Moneda base fija en USD</li>
              <li>‚Ä¢ Sin seguimiento de favoritos ---- ‚Ä¢ Sin an√°lisis t√©cnico ni recomendaciones</li>
            </ul>
          </div>
          <div class="banner-actions">
            <button mat-raised-button color="primary" (click)="router.navigate(['/register'])">
              <mat-icon>person_add</mat-icon>
              Crear Cuenta Gratis
            </button>
            <button mat-raised-button color="primary" (click)="router.navigate(['/login'])">
              <mat-icon>login</mat-icon>
              Iniciar Sesi√≥n
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
    
    <!-- SECCI√ìN 1: CONVERSOR + RESULTADO (2 columnas SIEMPRE visibles) -->
    <div class="converter-result-section">
      <!-- Conversor (Izquierda) - ADAPTADO AL TYPESCRIPT ACTUAL -->
      <mat-card class="currency-converter-card">
        <mat-card-header class="converter-card-header">
          <mat-card-title class="converter-card-title">
            <mat-icon>currency_exchange</mat-icon>
            Conversor de Divisas
          </mat-card-title>
          <mat-card-subtitle class="converter-card-subtitle">
            Conversi√≥n instant√°nea con datos del BCE
          </mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content class="converter-card-content">
          <form class="conversion-form">
            
            <!-- Cantidad a convertir -->
            <div class="amount-input-section">
              <label class="input-label" for="cantidad-input">Cantidad</label>
              <mat-form-field appearance="outline" class="amount-input-field">
                <input matInput 
                       type="number" 
                       id="cantidad-input"
                       [formControl]="cantidad"
                       placeholder="0.00"
                       class="amount-input">
              </mat-form-field>
            </div>

            <!-- Selecci√≥n de divisas -->
            <div class="currency-selector-grid">
              <!-- Divisa origen -->
              <div class="currency-selector-card from-card">
                <span class="selector-label">Desde</span>
                <mat-form-field appearance="outline" class="currency-select-field">
                  <mat-select [formControl]="monedaOrigen" 
                              (selectionChange)="limpiarResultado()">
                    <mat-option *ngFor="let currency of divisas" [value]="currency.code">
                      <div class="currency-option-content">
                        <span class="currency-display">{{ currency.code }} - {{ currency.name }}</span>
                      </div>
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <!-- Bot√≥n de intercambio -->
              <div class="swap-button-container">
                <button mat-fab 
                        size="mini"
                        color="primary" 
                        (click)="intercambiarDivisas()"
                        class="currency-swap-button"
                        type="button">
                  <mat-icon>swap_horiz</mat-icon>
                </button>
              </div>

              <!-- Divisa destino -->
              <div class="currency-selector-card to-card">
                <span class="selector-label">Hacia</span>
                <mat-form-field appearance="outline" class="currency-select-field">
                  <mat-select [formControl]="monedaDestino" 
                              (selectionChange)="limpiarResultado()">
                    <mat-option *ngFor="let currency of divisas" [value]="currency.code">
                      <div class="currency-option-content">
                        <span class="currency-display">{{ currency.code }} - {{ currency.name }}</span>
                      </div>
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>

            <!-- Bot√≥n convertir -->
            <div class="convert-button-section">
              <button mat-raised-button 
                      color="primary" 
                      (click)="convert()"
                      class="convert-action-button"
                      [disabled]="cargando || !cantidad.valid || !monedaOrigen.valid || !monedaDestino.valid"
                      type="button">
                <div class="button-content-wrapper">
                  <mat-icon *ngIf="!cargando">calculate</mat-icon>
                  <mat-progress-spinner 
                    *ngIf="cargando" 
                    diameter="18" 
                    mode="indeterminate">
                  </mat-progress-spinner>
                  <span>{{ cargando ? 'Convirtiendo...' : 'Convertir' }}</span>
                </div>
              </button>
            </div>

          </form>
        </mat-card-content>
      </mat-card>

      <!-- Resultado (Derecha) - ADAPTADO AL TYPESCRIPT ACTUAL -->
      <mat-card class="conversion-result-card">
        <mat-card-header class="result-card-header">
          <mat-card-title class="result-card-title">
            <mat-icon>insights</mat-icon>
            {{ resultado ? 'Resultado' : 'Panel de Resultados' }}
          </mat-card-title>
        </mat-card-header>

        <mat-card-content class="result-card-content">
          
          <!-- Mostrar resultado si existe -->
          <div class="conversion-result-display" *ngIf="resultado">
            
            <!-- Resultado principal -->
            <div class="main-result-section">
              <div class="conversion-equation">
                <span class="original-amount">{{ cantidad.value | number:'1.0-2':'es-ES' }} {{ monedaOrigen.value }}</span>
                <mat-icon class="equals-sign">keyboard_double_arrow_right</mat-icon>
              </div>
              
              <div class="converted-amount-display">
                <span class="result-number">{{ resultado.result | number:'1.2-2':'es-ES' }}</span>
                <span class="result-currency">{{ monedaDestino.value }}</span>
              </div>

              <div class="exchange-rate-info">
                <div class="rate-display-box">
                  <mat-icon>info_outline</mat-icon>
                  <span>1 {{ monedaOrigen.value }} = {{ resultado.rate | number:'1.4-4':'es-ES' }} {{ monedaDestino.value }}</span>
                </div>
              </div>
            </div>

            <!-- Informaci√≥n adicional en grid -->
            <div class="result-details-grid">
              <div class="detail-item">
                <mat-icon class="detail-icon">event</mat-icon>
                <div class="detail-content">
                  <span class="detail-label">Fecha</span>
                  <span class="detail-value">{{ formatearFecha(resultado.date) }}</span>
                </div>
              </div>

              <div class="detail-item">
                <mat-icon class="detail-icon">swap_horiz</mat-icon>
                <div class="detail-content">
                  <span class="detail-label">Inverso</span>
                  <span class="detail-value">1 {{ monedaDestino.value }} = {{ obtenerTasaInversa() | number:'1.4-4' }} {{ monedaOrigen.value }}</span>
                </div>
              </div>

              <div class="detail-item">
                <mat-icon class="detail-icon trending" [ngClass]="{
                  'trend-up': resultado.rate > 1,
                  'trend-down': resultado.rate < 1,
                  'trend-neutral': resultado.rate === 1
                }">
                  {{ resultado.rate > 1 ? 'trending_up' : resultado.rate < 1 ? 'trending_down' : 'trending_flat' }}
                </mat-icon>
                <div class="detail-content">
                  <span class="detail-label">Tendencia</span>
                  <span class="detail-value" [ngClass]="{
                    'strong': resultado.rate > 1,
                    'weak': resultado.rate < 1,
                    'neutral': resultado.rate === 1
                  }">
                    {{ resultado.rate > 1 ? 'Fuerte' : resultado.rate < 1 ? 'D√©bil' : 'Neutral' }}
                  </span>
                </div>
              </div>

              <div class="detail-item">
                <mat-icon class="detail-icon">schedule</mat-icon>
                <div class="detail-content">
                  <span class="detail-label">Actualizado</span>
                  <span class="detail-value">16:00 CET (diario)</span>
                </div>
              </div>
            </div>

            <!-- Acciones del resultado -->
            <div class="result-actions-section">
              <button mat-raised-button 
                      color="primary" 
                      (click)="intercambiarDivisas()"
                      class="result-action-btn">
                <mat-icon>swap_vert</mat-icon>
                Intercambiar
              </button>
              
              <button mat-stroked-button 
                      color="accent" 
                      (click)="copiarResultado()"
                      class="result-action-btn">
                <mat-icon>content_copy</mat-icon>
                Copiar
              </button>
            </div>
          </div>

          <!-- Mensaje de bienvenida si no hay resultado -->
          <div class="welcome-message-display" *ngIf="!resultado">
            <div class="welcome-icon-container">
              <mat-icon class="welcome-icon">calculate</mat-icon>
            </div>
            
            <div class="welcome-text-content">
              <h3 class="welcome-title">¬°Bienvenido al Conversor!</h3>
              
              <div class="instruction-steps">
                <div class="instruction-step">
                  <mat-icon class="step-icon">looks_one</mat-icon>
                  <span class="step-text">Introduce la <strong>cantidad</strong></span>
                </div>
                <div class="instruction-step">
                  <mat-icon class="step-icon">looks_two</mat-icon>
                  <span class="step-text">Selecciona las <strong>divisas</strong></span>
                </div>
                <div class="instruction-step">
                  <mat-icon class="step-icon">looks_3</mat-icon>
                  <span class="step-text">Haz clic en <strong>"Convertir"</strong></span>
                </div>
              </div>

              <div class="welcome-features">
                <div class="feature-chip">
                  <mat-icon>speed</mat-icon>
                  <span>Instant√°neo</span>
                </div>
              </div>

              <div class="quick-tip">
                <mat-icon>lightbulb</mat-icon>
                <span>Usa el bot√≥n de intercambio para invertir las divisas r√°pidamente</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- SECCI√ìN 2: ANALYTICS (4 cards horizontales) -->
    <mat-card class="analytics-compact" *ngIf="isAuthenticated && userStats">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>analytics</mat-icon>
          Tus Estad√≠sticas
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <div class="stats-grid-horizontal">
          <!-- Total Conversiones -->
          <div class="stat-card-compact conversions">
            <mat-icon>swap_horiz</mat-icon>
            <div class="stat-info">
              <span class="stat-number">{{ userStats.totalConversions }}</span>
              <span class="stat-label">Conversiones</span>
              <span class="stat-trend positive" *ngIf="userStats.weeklyTrend.includes('+')">{{ userStats.weeklyTrend }}</span>
            </div>
          </div>

          <!-- Volumen Total -->
          <div class="stat-card-compact volume">
            <mat-icon>attach_money</mat-icon>
            <div class="stat-info">
              <span class="stat-number">{{ formatVolume(userStats.totalVolume) }}</span>
              <span class="stat-label">Volumen (datos reales)</span>
              <small class="data-source">Basado en tipos BCE</small>
            </div>
          </div>

          <!-- Par Favorito -->
          <div class="stat-card-compact pair">
            <mat-icon>favorite</mat-icon>
            <div class="stat-info">
              <span class="stat-number">{{ userStats.topPair }}</span>
              <span class="stat-label">Top Par</span>
            </div>
          </div>

          <!-- Total Alertas -->
          <div class="stat-card-compact alerts">
            <mat-icon>notifications</mat-icon>
            <div class="stat-info">
              <span class="stat-number">{{ userStats.totalAlerts }}</span>
              <span class="stat-label">Alertas</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- SECCI√ìN 3: TENDENCIAS FAVORITOS (Compacta) -->
    <mat-card class="trends-compact" *ngIf="hasFavoriteTrends()">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>trending_up</mat-icon>
          Tendencias (7 d√≠as)
        </mat-card-title>
        <mat-card-subtitle>Tus pares favoritos</mat-card-subtitle>
      </mat-card-header>
      
      <mat-card-content>
        <div class="trends-horizontal">
          <div class="trend-item-compact" *ngFor="let trend of favoriteTrends?.trends">
            <div class="trend-pair-compact">
              <span class="pair-name">{{ trend.pair }}</span>
              <span class="current-rate">{{ trend.currentRate }}</span>
            </div>
            
            <div class="trend-change-compact" [ngClass]="{
              'trend-up': trend.trend === 'up',
              'trend-down': trend.trend === 'down',
              'trend-stable': trend.trend === 'stable'
            }">
              <mat-icon *ngIf="trend.trend === 'up'">trending_up</mat-icon>
              <mat-icon *ngIf="trend.trend === 'down'">trending_down</mat-icon>
              <mat-icon *ngIf="trend.trend === 'stable'">trending_flat</mat-icon>
              {{ trend.change }}
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- SECCI√ìN 4: Mercado de Divisas -->
    <mat-card class="rates-section-improved">
      <mat-card-header>
        <div class="rates-header">
          <div class="rates-title">
            <mat-card-title>  
              Mercado de Divisas 
              <mat-icon>trending_up</mat-icon>
            </mat-card-title>
            <mat-card-subtitle>
              Base: <strong>{{ monedaBase.value }}</strong> ‚Ä¢ Actualizado <strong>{{ ultimaActualizacion }}</strong>
              <span *ngIf="isLimitedMode" class="limited-indicator"> ‚Ä¢ Solo 8 divisas principales</span>
            </mat-card-subtitle>
          </div>
          
          <!-- ‚úÖ CONTROLES: Filtro + Selector -->
          <div class="rates-controls">
            <!-- üÜï FILTRO DE DIVISAS (solo usuarios registrados) -->
            <div class="currency-filter-section" *ngIf="isAuthenticated">
              <div class="filter-header">
                <mat-icon class="filter-icon">search</mat-icon>
                <span class="filter-title">Buscar Divisa</span>
              </div>
              
              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Filtrar por c√≥digo o nombre</mat-label>
                <input matInput 
                       [formControl]="currencyFilter"
                       placeholder="USD, Euro, D√≥lar..."
                       class="filter-input">
                <mat-icon matSuffix>search</mat-icon>
              </mat-form-field>
              
              <div class="filter-info">
                <mat-icon>info_outline</mat-icon>
                <span>Busca entre {{ tiposCambio.length }} divisas disponibles</span>
              </div>
            </div>

            <!-- SELECTOR DE MONEDA BASE -->
            <div class="currency-base-selector-modern" 
                 [class.disabled]="isLimitedMode">
              <div class="selector-header">
                <mat-icon class="selector-icon">settings</mat-icon>
                <span class="selector-title">Moneda Base</span>
              </div>
              
              <mat-form-field appearance="outline" class="base-select-field">
                <mat-label>Seleccionar base</mat-label>
                <mat-select [formControl]="monedaBase" 
                            (selectionChange)="cambiarMonedaBase()"
                            class="base-select">
                  <mat-option *ngFor="let divisa of getDivisasDisponibles()" 
                              [value]="divisa.code"
                              class="base-option">
                    <div class="option-content">
                      <span class="option-display">{{ divisa.code }} - {{ divisa.name }}</span>
                    </div>
                  </mat-option>
                </mat-select>
              </mat-form-field>
              
              <div class="selector-info">
                <mat-icon>info_outline</mat-icon>
                <span>Todas las tasas se muestran relativas a esta moneda</span>
              </div>
            </div>
          </div>
        </div>
      </mat-card-header>
      
      <mat-card-content>
        <!-- Loading state para datos reales -->
        <div class="loading-real-data" *ngIf="cargandoTabla">
          <div class="loading-content">
            <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
            <h3>Cargando datos reales del BCE</h3>
            <p>Obteniendo tasas de cambio y tendencias oficiales...</p>
          </div>
        </div>

        <!-- Grid de Cards de Divisas -->
        <div class="rates-grid" *ngIf="!cargandoTabla && (isAuthenticated ? filteredTiposCambio : tiposCambio).length > 0">
          <div class="rate-card"
               *ngFor="let rate of (isAuthenticated ? filteredTiposCambio : tiposCambio)"
               [ngClass]="{
                 'trending-up': rate.trendStatus === 'trending-up' && !rate.isBaseCurrency,
                 'trending-down': rate.trendStatus === 'trending-down' && !rate.isBaseCurrency,
                 'trending-stable': rate.trendStatus === 'trending-stable' || rate.isBaseCurrency,
                 'base-currency': rate.isBaseCurrency
               }">
            <div class="rate-content" [class.updating]="cargandoTabla">
              <!-- Header de la Card -->
              <div class="rate-header">
                <div class="currency-info">
                  <span class="flag">{{ rate.flag }}</span>
                  <div class="currency-details">
                    <strong class="currency-code">{{ rate.code }}</strong>
                    <small class="currency-name">{{ rate.name }}</small>
                  </div>
                </div>
                
                <!-- ‚úÖ ICONO ESPECIAL PARA MONEDA BASE -->
                <div class="trend-indicator" 
                     *ngIf="!rate.isBaseCurrency"
                     [ngClass]="{
                       'trend-up': rate.trendStatus === 'trending-up',
                       'trend-down': rate.trendStatus === 'trending-down', 
                       'trend-stable': rate.trendStatus === 'trending-stable'
                     }">
                  <mat-icon>
                    {{ rate.trendStatus === 'trending-up' ? 'trending_up' : rate.trendStatus === 'trending-down' ? 'trending_down' : 'trending_flat' }}
                  </mat-icon>
                </div>
              </div>

              <!-- Tasa Principal -->
              <div class="rate-main">
                <!-- ‚úÖ NUEVA L√çNEA: Etiqueta "1 USD =" -->
                <span class="base-currency-label" *ngIf="!rate.isBaseCurrency">
                  1 {{ monedaBase.value }} =
                </span>
                
                <span class="rate-value" [class.updating]="cargandoTabla">
                  {{ rate.isBaseCurrency ? '1.0000' : (rate.rate | number:'1.2-2') }}
                </span>
                <span class="rate-label">{{ rate.code }}</span>
              </div>

              <!-- Cambio y Porcentaje -->
              <div class="rate-change">
                <div class="trend-header" *ngIf="!rate.isBaseCurrency">
                  <mat-icon class="trend-icon">trending_up</mat-icon>
                  <span class="trend-title">Variaci√≥n</span>
                </div>
                <span class="change-percent" [ngClass]="{
                    'positive': rate.trendStatus === 'trending-up' && !rate.isBaseCurrency,
                    'negative': rate.trendStatus === 'trending-down' && !rate.isBaseCurrency,
                    'neutral': rate.isBaseCurrency || rate.trendStatus === 'trending-stable'
                }">
                  {{ rate.isBaseCurrency ? 'REFERENCIA' : rate.changeText }}
                  <small class="trend-period" *ngIf="!rate.isBaseCurrency">(7 d√≠as)</small>
                </span>
                <div class="trend-details">
                  <small class="change-label">{{ rate.isBaseCurrency ? 'Moneda base seleccionada' : 'Datos hist√≥ricos reales' }}</small>
                </div>
              </div>

              <!-- Informaci√≥n Adicional -->
              <div class="rate-extra">
                <div class="inverse-rate">
                  <mat-icon>swap_horiz</mat-icon>
                  <span>1 {{ rate.code }} = {{ rate.isBaseCurrency ? '1.0000' : ((1/rate.rate) | number:'1.2-6':'es-ES') }} {{ monedaBase.value }}</span>
                </div>
              </div>

              <!-- ‚úÖ ACCIONES ESPECIALES PARA BASE -->
              <div class="rate-actions-container">
                <button 
                  *ngIf="!rate.isBaseCurrency"
                  mat-raised-button 
                  color="primary" 
                  (click)="convertirA(rate.code)"
                  class="action-button">
                  Convertir a {{ rate.code }}
                </button>
                
                <button 
                  *ngIf="rate.isBaseCurrency"
                  mat-raised-button 
                  color="accent" 
                  class="action-button base-action"
                  disabled>
                  <mat-icon>home</mat-icon>
                  Base Actual
                </button>

                <button 
                  mat-raised-button 
                  [color]="isAuthenticated ? 'accent' : 'warn'"
                  (click)="handleDetalles(rate.code)"
                  class="action-button"
                  [attr.data-currency]="rate.code">
                  <mat-icon>{{ isAuthenticated ? 'analytics' : 'lock' }}</mat-icon>
                  {{ isAuthenticated ? 'Ver Detalles' : 'An√°lisis Premium' }}
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- üÜï MENSAJE CUANDO NO HAY RESULTADOS DE FILTRO -->
        <div class="no-filter-results" *ngIf="isAuthenticated && filteredTiposCambio.length === 0 && tiposCambio.length > 0 && currencyFilter.value?.trim()">
          <mat-icon>search_off</mat-icon>
          <h3>No se encontraron divisas</h3>
          <p>No hay divisas que coincidan con "<strong>{{ currencyFilter.value }}</strong>"</p>
          <div class="filter-suggestions">
            <p><strong>Prueba buscando:</strong></p>
            <ul>
              <li>C√≥digo de divisa: <em>USD, EUR, GBP, JPY</em></li>
              <li>Nombre completo: <em>D√≥lar, Euro, Libra</em></li>
              <li>Pa√≠s/regi√≥n: <em>Estadounidense, Europeo, Brit√°nico</em></li>
            </ul>
          </div>
          <button mat-raised-button color="primary" (click)="currencyFilter.setValue('')">
            <mat-icon>clear</mat-icon>
            Limpiar filtro
          </button>
        </div>

        <!-- Estado Vac√≠o -->
        <div class="empty-rates" *ngIf="!cargandoTabla && tiposCambio.length === 0">
          <mat-icon>error_outline</mat-icon>
          <h3>No se pudieron cargar los tipos de cambio</h3>
          <p>Verifica tu conexi√≥n e int√©ntalo de nuevo</p>
          <button mat-raised-button color="primary" (click)="cargarTiposCambio()">
            <mat-icon>refresh</mat-icon>
            Reintentar
          </button>
        </div>
      </mat-card-content>
    </mat-card>

  </div>

  <!-- MODAL PARA AN√ÅLISIS T√âCNICO - USUARIOS AUTENTICADOS -->
  <div class="currency-detail-modal technical-analysis-modal" 
       *ngIf="showCurrencyDetail" 
       (click)="closeCurrencyModal()"
       (keydown.escape)="closeCurrencyModal()"
       tabindex="0"
       role="dialog"
       aria-modal="true">
    <div class="modal-content" 
         (click)="$event.stopPropagation()"
         (keydown)="$event.stopPropagation()"
         tabindex="0">
      
      <!-- Bot√≥n de cerrar moderno -->
      <button class="modal-close-btn" (click)="closeCurrencyModal()">
        <mat-icon>close</mat-icon>
      </button>
      
      <!-- Header mejorado del Modal -->
      <div class="modal-header">
        <div class="header-content">
          <span class="currency-flag">{{ selectedCurrency?.flag }}</span>
          <div class="currency-info">
            <h2>{{ selectedCurrency?.name }}</h2>
            <span class="currency-subtitle">An√°lisis T√©cnico - {{ selectedCurrency?.code }}</span>
          </div>
          <div class="current-rate">
            <div class="rate-value">{{ selectedRate?.rate | number:'1.4-6' }}</div>
            <div class="rate-label">1 {{ monedaBase.value }} = {{ selectedRate?.rate | number:'1.4-6' }} {{ selectedCurrency?.code }}</div>
          </div>
        </div>
      </div>

      <!-- Contenido del Modal -->
      <div class="modal-body">
        
        <!-- SECCI√ìN 1: M√âTRICAS PRINCIPALES -->
        <div class="analysis-section">
          <div class="section-title">
            <mat-icon>analytics</mat-icon>
            <h3>M√©tricas de Mercado</h3>
          </div>
          
          <div class="metrics-grid">
            <!-- Precio y Tendencia -->
            <div class="metric-card price-card">
              <div class="metric-header">
                <mat-icon>trending_up</mat-icon>
                <span class="metric-title">Cotizaci√≥n</span>
              </div>
              <div class="metric-content">
                <div class="primary-value">{{ selectedRate?.rate | number:'1.4-6' }}</div>
                <div class="secondary-info">1 {{ monedaBase.value }} = {{ selectedRate?.rate | number:'1.4-6' }} {{ selectedCurrency?.code }}</div>
                <div class="trend-indicator" [ngClass]="{
                  'trend-up': tendenciaReal !== null && tendenciaReal > 0,
                  'trend-down': tendenciaReal !== null && tendenciaReal < 0,
                  'trend-neutral': tendenciaReal === null || tendenciaReal === 0
                }">
                  <mat-icon>{{ getTrendIcon() }}</mat-icon>
                  <span>{{ tendenciaReal !== null ? (tendenciaReal | number:'1.2-2') + '%' : 'Sin datos' }}</span>
                </div>
              </div>
            </div>

            <!-- Volatilidad -->
            <div class="metric-card volatility-card">
              <div class="metric-header">
                <mat-icon>show_chart</mat-icon>
                <span class="metric-title">Volatilidad</span>
              </div>
              <div class="metric-content">
                <div class="primary-value">{{ volatilidadReal !== null ? (volatilidadReal | number:'1.4-4') : '‚Äî' }}</div>
                <div class="secondary-info">Desviaci√≥n est√°ndar</div>
                <div class="volatility-level" [ngClass]="getVolatilityLevel(volatilidadReal || 0).toLowerCase()">
                  {{ getVolatilityLevel(volatilidadReal || 0) }}
                </div>
              </div>
            </div>

            <!-- Fuerza Relativa -->
            <div class="metric-card strength-card">
              <div class="metric-header">
                <mat-icon>balance</mat-icon>
                <span class="metric-title">Fuerza Relativa</span>
              </div>
              <div class="metric-content">
                <div class="primary-value" [ngClass]="{
                  'strong': (selectedRate?.rate || 1) > 1,
                  'weak': (selectedRate?.rate || 1) < 1
                }">{{ (selectedRate?.rate || 1) > 1 ? 'FUERTE' : 'D√âBIL' }}</div>
                <div class="secondary-info">vs {{ monedaBase.value }}</div>
                <div class="strength-bar">
                  <div class="strength-fill" [style.width.%]="Math.min(((selectedRate?.rate || 1) / 2) * 100, 100)"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCI√ìN 2: INDICADORES T√âCNICOS -->
        <div class="analysis-section">
          <div class="section-title">
            <mat-icon>speed</mat-icon>
            <h3>Indicadores T√©cnicos</h3>
          </div>
          
          <div class="indicators-grid">
            <!-- RSI -->
            <div class="indicator-card rsi-card">
              <div class="indicator-header">
                <span class="indicator-name">RSI</span>
                <span class="indicator-period">(14 d√≠as)</span>
              </div>
              <div class="indicator-value" [ngClass]="{
                'oversold': rsi !== null && rsi < 30,
                'normal': rsi !== null && rsi >= 30 && rsi <= 70,
                'overbought': rsi !== null && rsi > 70
              }">
                {{ rsi !== null ? (rsi | number:'1.1-1') : '‚Äî' }}
              </div>
              <div class="indicator-status">
                <span *ngIf="rsi === null">Sin datos</span>
                <span *ngIf="rsi !== null && rsi < 30" class="oversold">Sobrevendido</span>
                <span *ngIf="rsi !== null && rsi >= 30 && rsi <= 70" class="normal">Normal</span>
                <span *ngIf="rsi !== null && rsi > 70" class="overbought">Sobrecomprado</span>
              </div>
              <div class="rsi-bar">
                <div class="rsi-fill" [style.width.%]="rsi || 0"></div>
                <span class="rsi-marker oversold-mark">30</span>
                <span class="rsi-marker overbought-mark">70</span>
              </div>
            </div>

            <!-- SMA -->
            <div class="indicator-card sma-card">
              <div class="indicator-header">
                <span class="indicator-name">SMA</span>
                <span class="indicator-period">(7 d√≠as)</span>
              </div>
              <div class="indicator-value">
                {{ sma !== null ? (sma | number:'1.4-6') : '‚Äî' }}
              </div>
              <div class="indicator-status" *ngIf="getSmaComparison() as smaComp" [ngClass]="smaComp.class">
                {{ smaComp.text }}
              </div>
            </div>
          </div>
        </div>

        <!-- SECCI√ìN 3: RECOMENDACI√ìN IA (DESTACADA) -->
        <div class="recommendation-section" *ngIf="recomendacionReal">
          <div class="recommendation-card" [ngClass]="'rec-' + recomendacionReal.accion.toLowerCase()">
            <div class="recommendation-header">
              <div class="rec-icon-container">
                <mat-icon class="rec-icon">{{ getRecommendationIcon(recomendacionReal.accion) }}</mat-icon>
              </div>
              <div class="rec-title">
                <h3>Recomendaci√≥n de Inversi√≥n</h3>
                <span class="rec-subtitle">An√°lisis basado en IA</span>
              </div>
              <div class="rec-action">
                <span class="action-badge" [ngClass]="'badge-' + recomendacionReal.accion.toLowerCase()">
                  {{ recomendacionReal.accion }}
                </span>
              </div>
            </div>
            
            <div class="recommendation-content">
              <div class="rec-message">
                <mat-icon>psychology</mat-icon>
                <p>{{ recomendacionReal.mensaje }}</p>
              </div>
              
              <div class="rec-details" *ngIf="recomendacionReal.confianza || recomendacionReal.senales">
                <div class="confidence-meter" *ngIf="recomendacionReal.confianza">
                  <span class="confidence-label">Nivel de confianza</span>
                  <div class="confidence-bar">
                    <div class="confidence-fill" [style.width.%]="recomendacionReal.confianza"></div>
                  </div>
                  <span class="confidence-value">{{ recomendacionReal.confianza }}%</span>
                </div>
                
                <div class="signals-list" *ngIf="recomendacionReal.senales?.length">
                  <span class="signals-title">Se√±ales detectadas:</span>
                  <div class="signals-chips">
                    <span class="signal-chip" *ngFor="let senal of recomendacionReal.senales">{{ senal }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCI√ìN 4: ACCIONES R√ÅPIDAS -->
        <div class="actions-section">
          <div class="quick-actions">
            <button class="action-btn primary-action" (click)="convertirA(selectedCurrency?.code || '')">
              <mat-icon>currency_exchange</mat-icon>
              <span>Convertir a {{ selectedCurrency?.code }}</span>
            </button>
            
            <button class="action-btn secondary-action" (click)="addToFavorites()" *ngIf="isAuthenticated">
              <mat-icon>favorite_border</mat-icon>
              <span>A√±adir a Favoritos</span>
            </button>
            
            <button class="action-btn tertiary-action" (click)="compartirResultado()">
              <mat-icon>share</mat-icon>
              <span>Compartir An√°lisis</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL PREMIUM PARA USUARIOS NO REGISTRADOS -->
  <div class="currency-detail-modal premium-modal premium-promotion-modal" 
       *ngIf="showPremiumModal" 
       (click)="onPremiumModalBackground($event)"
       (keydown.escape)="closePremiumModal()"
       tabindex="0"
       role="dialog"
       aria-modal="true">
    
    <div class="modal-content" 
         (click)="$event.stopPropagation()"
         (keydown)="$event.stopPropagation()"
         tabindex="0">
      
      <!-- Bot√≥n de cerrar moderno -->
      <button class="modal-close-btn" (click)="closePremiumModal()">
        <mat-icon>close</mat-icon>
      </button>

      <!-- Header premium -->
      <div class="modal-header">
        <div class="premium-lock-icon">
          <mat-icon>lock</mat-icon>
        </div>
        
        <div class="premium-header-content">
          <h2>üåü An√°lisis Premium de {{ premiumCurrency?.code }}</h2>
          <p>Desbloquea an√°lisis t√©cnico avanzado y recomendaciones de inversi√≥n personalizadas</p>
        </div>
      </div>

      <!-- Contenido del modal -->
      <div class="modal-body">
        <!-- Lista de caracter√≠sticas -->
        <div class="premium-features">
          <div class="feature-item">
            <mat-icon>trending_up</mat-icon>
            <span class="feature-text">An√°lisis t√©cnico en tiempo real</span>
          </div>
          <div class="feature-item">
            <mat-icon>insights</mat-icon>
            <span class="feature-text">Indicadores RSI, SMA y volatilidad</span>
          </div>
          <div class="feature-item">
            <mat-icon>psychology</mat-icon>
            <span class="feature-text">Recomendaciones de inversi√≥n IA</span>
          </div>
          <div class="feature-item">
            <mat-icon>history</mat-icon>
            <span class="feature-text">Hist√≥ricos de 30 d√≠as</span>
          </div>
          <div class="feature-item">
            <mat-icon>favorite</mat-icon>
            <span class="feature-text">Seguimiento de favoritos</span>
          </div>
          <div class="feature-item">
            <mat-icon>notifications</mat-icon>
            <span class="feature-text">Alertas personalizadas</span>
          </div>
        </div>

        <!-- Botones de acci√≥n -->
        <div class="premium-actions">
          <button class="premium-btn" (click)="goToRegister()">
            <mat-icon>person_add</mat-icon>
            Crear Cuenta Gratis
          </button>
          
          <button class="premium-btn secondary" (click)="goToLogin()">
            <mat-icon>login</mat-icon>
            Ya tengo cuenta
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- BANNER DE INFORMACI√ìN - MOVIDO FUERA DE LOS MODALES -->
  <div class="update-info-banner" *ngIf="!showCurrencyDetail && !showPremiumModal">
    <mat-icon>info</mat-icon>
    <div class="update-info-content">
      <span class="update-timestamp">Datos actualizados: {{ ultimaActualizacion }}</span>
      <div class="update-details">
        <small class="update-note"> ‚Ä¢ Tipos de cambio oficiales del Banco Central Europeo</small>
        <small class="update-note"> ‚Ä¢ Tendencias calculadas con datos de 30 d√≠as</small>
        <small class="update-note"> ‚Ä¢ Actualizaci√≥n diaria a las 16:00 CET</small>
      </div>
    </div>
  </div>
</div>
