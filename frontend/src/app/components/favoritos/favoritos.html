<div class="favoritos-container">
  <div class="content-wrapper">
    <!-- Header integrado como en historial -->
    <div class="favoritos-header">
      <div class="title-container">
        <h1 class="simple-title">
          <mat-icon class="favorite-symbol">star</mat-icon>
          Tu Centro de Control de Divisas
        </h1>

        <div class="title-tagline">
          <p class="tagline-text">
            Gestiona y monitorea tus favorritos de divisas y pares en tiempo real
            <br />
          </p>
        </div>
      </div>

      <!-- Sección de gestión rápida integrada en el header -->
      <div class="filters-section">
        <div class="filters-header">
          <div class="filters-title">
            <mat-icon>dashboard</mat-icon>
            <span>Gestión Rápida</span>
          </div>
          <div class="quick-actions">
            <button
              mat-raised-button
              color="primary"
              (click)="openAddFavoriteDialog()"
              class="quick-action-btn"
            >
              <mat-icon>add</mat-icon>
              Añadir Par
            </button>
            <button
              mat-raised-button
              color="accent"
              (click)="openAddCurrencyDialog()"
              class="quick-action-btn"
            >
              <mat-icon>monetization_on</mat-icon>
              Añadir Divisa
            </button>
          </div>
        </div>
      </div>
    </div>

  <!-- ⭐ SECCIÓN 1: DIVISAS FAVORITAS (AHORA PRIMERA) -->
  <mat-card class="favorites-section-card currencies-section-enhanced">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>star</mat-icon>
        Divisas Favoritas ({{ favoriteCurrencies.length }})
      </mat-card-title>
      <button
        mat-raised-button
        class="header-action-btn"
        (click)="openAddCurrencyDialog()"
      >
        <mat-icon>add</mat-icon>
        Añadir Divisa
      </button>
    </mat-card-header>

    <mat-card-content>
      <!-- Loading -->
      <div
        *ngIf="loading && favoriteCurrencies.length === 0"
        class="loading-container"
      >
        <mat-spinner diameter="40"></mat-spinner>
        <p>Cargando divisas favoritas...</p>
      </div>

      <!-- Sin divisas favoritas -->
      <div
        *ngIf="!loading && favoriteCurrencies.length === 0"
        class="no-data-message"
      >
        <mat-icon class="no-data-icon">star_border</mat-icon>
        <h3>No tienes divisas favoritas</h3>
        <p>Añade divisas individuales para monitorear sus tipos de cambio</p>
        <button
          mat-raised-button
          class="action-btn primary"
          (click)="openAddCurrencyDialog()"
        >
          <mat-icon>add</mat-icon>
          Añadir Primera Divisa
        </button>
      </div>

      <!-- Grid de divisas favoritas mejorado -->
      <div 
        *ngIf="favoriteCurrencies.length > 0" 
        class="currencies-grid-enhanced"
      >
        <div
          *ngFor="let currency of favoriteCurrencies; trackBy: trackByFavoriteCurrency"
          class="currency-card-enhanced"
          [ngClass]="{
            'trending-up': (currency.change || 0) > 0,
            'trending-down': (currency.change || 0) < 0,
            'trending-neutral': (currency.change || 0) === 0
          }"
        >
          <!-- Header de la divisa -->
          <div class="currency-header">
            <div class="currency-info">
              <div class="currency-code">{{ currency.currency }}</div>
              <div class="currency-nickname" *ngIf="currency.nickname">{{ currency.nickname }}</div>
              <mat-chip *ngIf="currency.isDefault" class="default-chip">Por defecto</mat-chip>
            </div>
            <div class="trend-indicator">
              <mat-icon 
                *ngIf="(currency.change || 0) > 0"
                class="trend-up"
              >trending_up</mat-icon>
              <mat-icon 
                *ngIf="(currency.change || 0) < 0"
                class="trend-down"
              >trending_down</mat-icon>
              <mat-icon 
                *ngIf="(currency.change || 0) === 0"
                class="trend-neutral"
              >trending_flat</mat-icon>
            </div>
          </div>

          <!-- Información principal -->
          <div class="currency-main-info">
            <div class="exchange-rate">
              <div class="rate-value">{{ getCurrentRateForCurrency(currency) | number:'1.4-4' }}</div>
              <div class="rate-label">1 {{ baseCurrency }} = {{ currency.currency }}</div>
            </div>
            <div class="change-display">
              <div
                class="change-value"
                [ngClass]="{
                  'positive': (currency.change || 0) > 0,
                  'negative': (currency.change || 0) < 0,
                  'neutral': (currency.change || 0) === 0
                }"
              >
                {{ currency.changeText || formatPercentageChange(currency.change || 0) }}
              </div>
              <div class="change-label">Variación 24h</div>
            </div>
          </div>

          <!-- Acciones -->
          <div class="currency-actions">
            <button
              mat-button
              class="action-btn edit-btn"
              (click)="editFavoriteCurrency(currency)"
              matTooltip="Editar nickname"
            >
              <mat-icon>edit</mat-icon>
              <span class="btn-text">Editar</span>
            </button>
            
            <button
              mat-button
              class="action-btn favorite-btn"
              [ngClass]="{ 'is-default': currency.isDefault }"
              (click)="toggleDefaultCurrency(currency)"
              [matTooltip]="currency.isDefault ? 'Quitar como predeterminada' : 'Marcar como predeterminada'"
            >
              <mat-icon>{{ currency.isDefault ? 'star' : 'star_border' }}</mat-icon>
              <span class="btn-text">{{ currency.isDefault ? 'Default' : 'Marcar' }}</span>
            </button>
            
            <button
              mat-button
              class="action-btn convert-btn"
              (click)="useInQuickConversionCurrency(currency)"
              matTooltip="Usar en conversión rápida"
            >
              <mat-icon>swap_horiz</mat-icon>
              <span class="btn-text">Convertir</span>
            </button>
            
            <button
              mat-button
              class="action-btn remove-btn"
              (click)="deleteFavoriteCurrency(currency)"
              matTooltip="Eliminar divisa favorita"
            >
              <mat-icon>delete</mat-icon>
              <span class="btn-text">Eliminar</span>
            </button>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- SECCIÓN 2: PARES FAVORITOS (AHORA SEGUNDA) -->
  <mat-card class="section-card favorites-section-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>star</mat-icon>
        Pares Favoritos ({{ favoritePairs.length }})
      </mat-card-title>
      <button
        mat-raised-button
        color="primary"
        (click)="openAddFavoriteDialog()"
        class="header-action-btn"
      >
        <mat-icon>add</mat-icon>
        Añadir Par
      </button>
    </mat-card-header>

    <mat-card-content>
      <!-- Loading -->
      <div
        *ngIf="loading && favoritePairs.length === 0"
        class="loading-container"
      >
        <mat-spinner diameter="40"></mat-spinner>
        <p>Cargando favoritos...</p>
      </div>

      <!-- Sin favoritos -->
      <div
        *ngIf="!loading && favoritePairs.length === 0"
        class="empty-favorites"
      >
        <mat-icon class="empty-icon">star_border</mat-icon>
        <h3>No tienes pares favoritos</h3>
        <p>
          Añade tus pares de divisas favoritos para monitorearlos en tiempo
          real
        </p>
        <button
          mat-raised-button
          color="primary"
          (click)="openAddFavoriteDialog()"
        >
          <mat-icon>add</mat-icon>
          Añadir Primer Favorito
        </button>
      </div>

      <!-- Grid de favoritos mejorado -->
      <div *ngIf="favoritePairs.length > 0" class="favorites-grid-enhanced">
        <div
          *ngFor="let favorite of favoritePairs; trackBy: trackByFavorite"
          class="favorite-card-enhanced"
          [class.trending-up]="(favorite.change || 0) > 0"
          [class.trending-down]="(favorite.change || 0) < 0"
          [class.trending-neutral]="(favorite.change || 0) === 0"
        >
          <!-- Header del par -->
          <div class="favorite-header">
            <div class="pair-info">
              <span class="pair-code">
                {{ favorite.pair }}
              </span>
              <span class="pair-nickname" *ngIf="favorite.nickname">
                {{ favorite.nickname }}
              </span>
            </div>
            <div class="trend-indicator">
              <mat-icon *ngIf="(favorite.change || 0) > 0" class="trend-up">trending_up</mat-icon>
              <mat-icon *ngIf="(favorite.change || 0) < 0" class="trend-down">trending_down</mat-icon>
              <mat-icon *ngIf="(favorite.change || 0) === 0" class="trend-neutral">trending_flat</mat-icon>
            </div>
          </div>

          <!-- Información principal -->
          <div class="favorite-main-info">
            <div class="current-rate">
              <span class="rate-value">{{ favorite.currentRate | number : '1.4-4' }}</span>
              <span class="rate-label">Tasa actual</span>
            </div>
            <div class="change-display">
              <span 
                class="change-value"
                [class.positive]="(favorite.change || 0) > 0"
                [class.negative]="(favorite.change || 0) < 0"
                [class.neutral]="(favorite.change || 0) === 0"
              >
                {{ favorite.changeText || formatPercentageChange(favorite.change || 0) }}
              </span>
              <span class="change-label">Cambio 24h</span>
            </div>
          </div>

          <!-- Acciones -->
          <div class="favorite-actions">
            <button
              mat-button
              class="action-btn edit-btn"
              (click)="editFavorite(favorite)"
              matTooltip="Editar nickname"
            >
              <mat-icon>edit</mat-icon>
              <span class="btn-text">Editar</span>
            </button>
            <button
              mat-button
              class="action-btn alert-btn"
              (click)="navigateToAlerts(favorite.from, favorite.to)"
              matTooltip="Crear alerta"
            >
              <mat-icon>notifications</mat-icon>
              <span class="btn-text">Alerta</span>
            </button>
            <button
              mat-button
              class="action-btn convert-btn"
              (click)="useInQuickConversion(favorite)"
              matTooltip="Usar en conversión rápida"
            >
              <mat-icon>swap_horiz</mat-icon>
              <span class="btn-text">Convertir</span>
            </button>
            <button
              mat-button
              class="action-btn remove-btn"
              (click)="deleteFavorite(favorite)"
              matTooltip="Eliminar favorito"
            >
              <mat-icon>delete</mat-icon>
              <span class="btn-text">Eliminar</span>
            </button>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- SECCIÓN 3: CONVERSIÓN RÁPIDA -->
  <mat-card class="section-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>swap_horiz</mat-icon>
        Conversión Rápida entre Favoritos
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="quickConversionForm" class="conversion-panel">
        <mat-form-field class="amount-field" appearance="outline">
          <mat-label>Cantidad</mat-label>
          <input
            matInput
            type="number"
            formControlName="amount"
            min="0"
            step="0.01"
          />
        </mat-form-field>

        <mat-form-field class="currency-field" appearance="outline">
          <mat-label>De</mat-label>
          <mat-select
            formControlName="from"
            (selectionChange)="onFromCurrencyChange()"
          >
            <mat-option
              *ngFor="let currency of getFavoriteCurrencies()"
              [value]="currency"
            >
              {{ getCurrencyFlag(currency) }} {{ currency }}
              {{ getCurrencyName(currency) }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <button
          mat-icon-button
          type="button"
          class="swap-btn"
          color="primary"
          (click)="swapCurrencies()"
          matTooltip="Intercambiar monedas"
        >
          <mat-icon>swap_horiz</mat-icon>
        </button>

        <mat-form-field class="currency-field" appearance="outline">
          <mat-label>A</mat-label>
          <mat-select
            formControlName="to"
            (selectionChange)="calculateQuickConversion()"
          >
            <mat-option
              *ngFor="let currency of getFilteredToCurrencies()"
              [value]="currency"
            >
              {{ getCurrencyFlag(currency) }} {{ currency }}
              {{ getCurrencyName(currency) }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <div class="result-panel">
          <div *ngIf="quickConversionLoading" class="result-loading">
            <mat-spinner diameter="20"></mat-spinner>
            <span>Calculando...</span>
          </div>
          <div
            *ngIf="!quickConversionLoading && quickConversionResult"
            class="result-success"
          >
            <span class="result-label">Resultado:</span>
            <span class="result-value">
              {{ quickConversionResult.result | number : '1.2-2' }}
              {{ quickConversionResult.to }}
            </span>
            <span class="result-rate">
              1 {{ quickConversionResult.from }} =
              {{ quickConversionResult.rate | number : '1.4-4' }}
              {{ quickConversionResult.to }}
            </span>
          </div>
          <div
            *ngIf="!quickConversionLoading && !quickConversionResult"
            class="result-empty"
          >
            <span>Selecciona monedas para ver el resultado</span>
          </div>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- SECCIÓN 4: RESUMEN DEL DÍA -->
  <div
    class="summary-row"
    *ngIf="favoritePairs.length > 0 || favoriteCurrencies.length > 0"
  >
    <!-- Mejor Performer -->
    <mat-card class="summary-card">
      <mat-card-header>
        <mat-card-title class="trending-up-icon">
          <mat-icon>trending_up</mat-icon>
          Mejor Performer
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div
          class="performer-info"
          *ngIf="getBestPerformer(); else noPerformer"
        >
          <span class="performer-pair">
            {{ getBestPerformer()?.name }}
            <span
              class="performer-type"
              *ngIf="getBestPerformer()?.type === 'currency'"
            >
              (Divisa)</span
            >
          </span>
          <span class="performer-change positive">{{
            formatPercentageChange(getBestPerformer()?.change || 0)
          }}</span>
        </div>
        <p class="performer-description">
          Tu favorito con mejor rendimiento hoy
        </p>
      </mat-card-content>
    </mat-card>

    <!-- Peor Performer -->
    <mat-card class="summary-card">
      <mat-card-header>
        <mat-card-title class="trending-down-icon">
          <mat-icon>trending_down</mat-icon>
          Necesita Atención
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div
          class="performer-info"
          *ngIf="getWorstPerformer(); else noPerformer"
        >
          <span class="performer-pair">
            {{ getWorstPerformer()?.name }}
            <span
              class="performer-type"
              *ngIf="getWorstPerformer()?.type === 'currency'"
            >
              (Divisa)</span
            >
          </span>
          <span class="performer-change negative">{{
            formatPercentageChange(getWorstPerformer()?.change || 0)
          }}</span>
        </div>
        <p class="performer-description">
          Revisa las tendencias de este par
        </p>
      </mat-card-content>
    </mat-card>

    <!-- Total Favoritos -->
    <mat-card class="summary-card">
      <mat-card-header>
        <mat-card-title class="star-icon">
          <mat-icon>star</mat-icon>
          Total Favoritos
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="total-info">
          <span class="total-count">{{ getTotalFavorites() }}</span>
          <span class="total-label">favoritos activos</span>
        </div>
        <div class="breakdown-info">
          <small
            >{{ favoritePairs.length }} pares •
            {{ favoriteCurrencies.length }} divisas</small
          >
        </div>
        <p class="total-description">
          Gestiona todos tus favoritos desde aquí
        </p>
      </mat-card-content>
    </mat-card>

    <!-- Promedio de Cambios -->
    <mat-card class="summary-card">
      <mat-card-header>
        <mat-card-title class="analytics-icon">
          <mat-icon>analytics</mat-icon>
          Rendimiento Promedio
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="metric-info">
          <span
            class="metric-value"
            [class.positive]="getAverageChange() > 0"
            [class.negative]="getAverageChange() < 0"
          >
            {{ formatPercentageChange(getAverageChange()) }}
          </span>
          <span class="metric-label">cambio promedio</span>
        </div>
        <div class="metric-details">
          <small
            >{{ getPositiveChangesCount() }} de {{ getTotalFavorites() }} en
            positivo</small
          >
        </div>
        <p class="metric-description">Rendimiento general de tu cartera</p>
      </mat-card-content>
    </mat-card>

    <!-- Estado del Mercado -->
    <mat-card class="summary-card">
      <mat-card-header>
        <mat-card-title class="market-icon">
          <mat-icon [style.color]="getMarketStatus().color">{{
            getMarketStatus().icon
          }}</mat-icon>
          Estado del Mercado
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="market-info">
          <span
            class="market-status"
            [style.color]="getMarketStatus().color"
          >
            {{ getMarketStatus().status }}
          </span>
          <span class="market-time">{{ getMostActiveTime() }}</span>
        </div>
        <div class="volatility-info">
          <small>Volatilidad: {{ getVolatilityLevel() }}</small>
        </div>
        <p class="market-description">Horario y actividad actual</p>
      </mat-card-content>
    </mat-card>

    <!-- Selector de Divisa Base -->
    <mat-card class="summary-card base-currency-card">
      <mat-card-header>
        <mat-card-title class="base-currency-icon">
          <mat-icon>language</mat-icon>
          Divisa Base
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="base-currency-selector">
          <mat-form-field appearance="outline" class="base-currency-field">
            <mat-label>Cambiar divisa base</mat-label>
            <mat-select [formControl]="baseCurrencyControl">
              <mat-option
                *ngFor="let currency of availableBaseCurrencies"
                [value]="currency.code"
              >
                <div class="currency-option">
                  <span class="currency-flag">{{ currency.flag }}</span>
                  <span class="currency-code">{{ currency.code }}</span>
                  <span class="currency-name">{{ currency.name }}</span>
                </div>
              </mat-option>
            </mat-select>
          </mat-form-field>
          <div class="base-currency-info">
            <small
              >Los tipos de cambio se mostrarán desde
              {{ baseCurrency }}</small
            >
          </div>
        </div>
        <p class="base-currency-description">
          Personaliza tu divisa de referencia
        </p>
      </mat-card-content>
    </mat-card>

    <ng-template #noPerformer>
      <div class="no-performer">
        <span>Sin datos suficientes</span>
      </div>
    </ng-template>
  </div>
  </div>
</div>