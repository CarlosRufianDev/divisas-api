<div class="favoritos-container">
  <div class="content-wrapper">
    <!-- Header integrado como en historial -->
    <div class="favoritos-header">
      <div class="title-container">
        <h1 class="simple-title">
          <mat-icon class="favorite-symbol">star</mat-icon>
          Tu Centro de Control de Divisas
        </h1>

        <div class="title-tagline">
          <p class="tagline-text">
            Gestiona y monitorea tus pares favoritos con herramientas profesionales
          </p>
        </div>
      </div>

      <!-- Sección de gestión rápida integrada en el header -->
      <div class="filters-section">
        <div class="filters-header">
          <div class="filters-title">
            <mat-icon>dashboard</mat-icon>
            <span>Gestión Rápida</span>
          </div>
          <div class="quick-actions">
            <button
              mat-raised-button
              color="primary"
              (click)="openAddFavoriteDialog()"
              class="quick-action-btn"
            >
              <mat-icon>add</mat-icon>
              Añadir Par
            </button>
            <button
              mat-raised-button
              color="accent"
              (click)="openAddCurrencyDialog()"
              class="quick-action-btn"
            >
              <mat-icon>monetization_on</mat-icon>
              Añadir Divisa
            </button>
          </div>
        </div>
      </div>
    </div>

  <!-- SECCIÓN 1: FAVORITOS ACTIVOS -->
  <mat-card class="section-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>star</mat-icon>
        Pares Favoritos ({{ favoritePairs.length }})
      </mat-card-title>
      <button
        mat-raised-button
        color="primary"
        (click)="openAddFavoriteDialog()"
      >
        <mat-icon>add</mat-icon>
        Añadir Par
      </button>
    </mat-card-header>

    <mat-card-content>
      <!-- Loading -->
      <div
        *ngIf="loading && favoritePairs.length === 0"
        class="loading-container"
      >
        <mat-spinner diameter="40"></mat-spinner>
        <p>Cargando favoritos...</p>
      </div>

      <!-- Sin favoritos -->
      <div
        *ngIf="!loading && favoritePairs.length === 0"
        class="empty-favorites"
      >
        <mat-icon class="empty-icon">star_border</mat-icon>
        <h3>No tienes pares favoritos</h3>
        <p>
          Añade tus pares de divisas favoritos para monitorearlos en tiempo
          real
        </p>
        <button
          mat-raised-button
          color="primary"
          (click)="openAddFavoriteDialog()"
        >
          <mat-icon>add</mat-icon>
          Añadir Primer Favorito
        </button>
      </div>

      <!-- Grid de favoritos -->
      <div *ngIf="favoritePairs.length > 0" class="favoritos-grid">
        <div
          *ngFor="let favorite of favoritePairs; trackBy: trackByFavorite"
          class="favorito-item"
          [class.trending-up]="(favorite.change || 0) > 0"
          [class.trending-down]="(favorite.change || 0) < 0"
          [class.trending-neutral]="(favorite.change || 0) === 0"
        >
          <div class="par-info">
            <div class="par-header">
              <span class="par-name">{{ favorite.pair }}</span>
              <span class="par-nickname" *ngIf="favorite.nickname">{{
                favorite.nickname
              }}</span>
            </div>
            <span class="par-rate">{{
              favorite.currentRate | number : '1.4-4'
            }}</span>
          </div>

          <div
            class="par-change"
            [class.positive]="(favorite.change || 0) > 0"
            [class.negative]="(favorite.change || 0) < 0"
            [class.neutral]="(favorite.change || 0) === 0"
          >
            <mat-icon *ngIf="(favorite.change || 0) > 0"
              >trending_up</mat-icon
            >
            <mat-icon *ngIf="(favorite.change || 0) < 0"
              >trending_down</mat-icon
            >
            <mat-icon *ngIf="(favorite.change || 0) === 0"
              >trending_flat</mat-icon
            >
            <span>{{
              favorite.changeText ||
                formatPercentageChange(favorite.change || 0)
            }}</span>
          </div>

          <div class="par-actions">
            <button
              mat-icon-button
              (click)="editFavorite(favorite)"
              matTooltip="Editar nickname"
            >
              <mat-icon>edit</mat-icon>
            </button>
            <button
              mat-icon-button
              (click)="deleteFavorite(favorite)"
              matTooltip="Eliminar favorito"
              color="warn"
            >
              <mat-icon>delete</mat-icon>
            </button>
            <button
              mat-icon-button
              (click)="useInQuickConversion(favorite)"
              matTooltip="Usar en conversión rápida"
              color="primary"
            >
              <mat-icon>swap_horiz</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- SECCIÓN 1.5: DIVISAS FAVORITAS INDIVIDUALES -->
  <mat-card class="section-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>monetization_on</mat-icon>
        Divisas Favoritas ({{ favoriteCurrencies.length }})
      </mat-card-title>
      <button
        mat-raised-button
        color="accent"
        (click)="openAddCurrencyDialog()"
      >
        <mat-icon>add</mat-icon>
        Añadir Divisa
      </button>
    </mat-card-header>

    <mat-card-content>
      <!-- Loading -->
      <div
        *ngIf="loading && favoriteCurrencies.length === 0"
        class="loading-container"
      >
        <mat-spinner diameter="40"></mat-spinner>
        <p>Cargando divisas favoritas...</p>
      </div>

      <!-- Sin divisas favoritas -->
      <div
        *ngIf="!loading && favoriteCurrencies.length === 0"
        class="empty-favorites"
      >
        <mat-icon class="empty-icon">monetization_on</mat-icon>
        <h3>No tienes divisas favoritas</h3>
        <p>
          Añade divisas individuales para monitorear sus tipos de cambio
        </p>
        <button
          mat-raised-button
          color="accent"
          (click)="openAddCurrencyDialog()"
        >
          <mat-icon>add</mat-icon>
          Añadir Primera Divisa
        </button>
      </div>

      <!-- Grid de divisas favoritas -->
      <div *ngIf="favoriteCurrencies.length > 0" class="currencies-grid">
        <div
          *ngFor="
            let currency of favoriteCurrencies;
            trackBy: trackByFavoriteCurrency
          "
          class="currency-item"
          [class.trending-up]="(currency.change || 0) > 0"
          [class.trending-down]="(currency.change || 0) < 0"
          [class.trending-neutral]="(currency.change || 0) === 0"
        >
          <div class="currency-info">
            <div class="currency-header">
              <span class="currency-code">{{ currency.currency }}</span>
              <span class="currency-nickname" *ngIf="currency.nickname">{{
                currency.nickname
              }}</span>
              <mat-chip
                *ngIf="currency.isDefault"
                class="default-chip"
                color="primary"
              >
                Por defecto
              </mat-chip>
            </div>
            <span class="currency-rate">
              1 {{ baseCurrency }} =
              {{ getCurrentRateForCurrency(currency) | number : '1.4-4' }}
              {{ currency.currency }}
            </span>
          </div>

          <div
            class="currency-change"
            [class.positive]="(currency.change || 0) > 0"
            [class.negative]="(currency.change || 0) < 0"
            [class.neutral]="(currency.change || 0) === 0"
          >
            <mat-icon *ngIf="(currency.change || 0) > 0"
              >trending_up</mat-icon
            >
            <mat-icon *ngIf="(currency.change || 0) < 0"
              >trending_down</mat-icon
            >
            <mat-icon *ngIf="(currency.change || 0) === 0"
              >trending_flat</mat-icon
            >
            <span>{{
              currency.changeText ||
                formatPercentageChange(currency.change || 0)
            }}</span>
          </div>

          <div class="currency-actions">
            <button
              mat-icon-button
              (click)="editFavoriteCurrency(currency)"
              matTooltip="Editar nickname"
            >
              <mat-icon>edit</mat-icon>
            </button>
            <button
              mat-icon-button
              (click)="toggleDefaultCurrency(currency)"
              [matTooltip]="
                currency.isDefault
                  ? 'Quitar como predeterminada'
                  : 'Marcar como predeterminada'
              "
              color="primary"
            >
              <mat-icon>{{
                currency.isDefault ? 'star' : 'star_border'
              }}</mat-icon>
            </button>
            <button
              mat-icon-button
              (click)="deleteFavoriteCurrency(currency)"
              matTooltip="Eliminar divisa favorita"
              color="warn"
            >
              <mat-icon>delete</mat-icon>
            </button>
            <button
              mat-icon-button
              (click)="useInQuickConversionCurrency(currency)"
              matTooltip="Usar en conversión rápida"
              color="primary"
            >
              <mat-icon>swap_horiz</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- SECCIÓN 2: CONVERSIÓN RÁPIDA -->
  <mat-card class="section-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>swap_horiz</mat-icon>
        Conversión Rápida entre Favoritos
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="quickConversionForm" class="conversion-panel">
        <mat-form-field class="amount-field" appearance="outline">
          <mat-label>Cantidad</mat-label>
          <input
            matInput
            type="number"
            formControlName="amount"
            min="0"
            step="0.01"
          />
          <span matPrefix>💰 </span>
        </mat-form-field>

        <mat-form-field class="currency-field" appearance="outline">
          <mat-label>De</mat-label>
          <mat-select
            formControlName="from"
            (selectionChange)="onFromCurrencyChange()"
          >
            <mat-option
              *ngFor="let currency of getFavoriteCurrencies()"
              [value]="currency"
            >
              {{ getCurrencyFlag(currency) }} {{ currency }}
              {{ getCurrencyName(currency) }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <button
          mat-icon-button
          type="button"
          class="swap-btn"
          color="primary"
          (click)="swapCurrencies()"
          matTooltip="Intercambiar monedas"
        >
          <mat-icon>swap_horiz</mat-icon>
        </button>

        <mat-form-field class="currency-field" appearance="outline">
          <mat-label>A</mat-label>
          <mat-select
            formControlName="to"
            (selectionChange)="calculateQuickConversion()"
          >
            <mat-option
              *ngFor="let currency of getFilteredToCurrencies()"
              [value]="currency"
            >
              {{ getCurrencyFlag(currency) }} {{ currency }}
              {{ getCurrencyName(currency) }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <div class="result-panel">
          <div *ngIf="quickConversionLoading" class="result-loading">
            <mat-spinner diameter="20"></mat-spinner>
            <span>Calculando...</span>
          </div>
          <div
            *ngIf="!quickConversionLoading && quickConversionResult"
            class="result-success"
          >
            <span class="result-label">Resultado:</span>
            <span class="result-value">
              {{ quickConversionResult.result | number : '1.2-2' }}
              {{ quickConversionResult.to }}
            </span>
            <span class="result-rate">
              1 {{ quickConversionResult.from }} =
              {{ quickConversionResult.rate | number : '1.4-4' }}
              {{ quickConversionResult.to }}
            </span>
          </div>
          <div
            *ngIf="!quickConversionLoading && !quickConversionResult"
            class="result-empty"
          >
            <span>Selecciona monedas para ver el resultado</span>
          </div>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- SECCIÓN 3: RESUMEN DEL DÍA -->
  <div
    class="summary-row"
    *ngIf="favoritePairs.length > 0 || favoriteCurrencies.length > 0"
  >
    <!-- Mejor Performer -->
    <mat-card class="summary-card">
      <mat-card-header>
        <mat-card-title class="trending-up-icon">
          <mat-icon>trending_up</mat-icon>
          Mejor Performer
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div
          class="performer-info"
          *ngIf="getBestPerformer(); else noPerformer"
        >
          <span class="performer-pair">
            {{ getBestPerformer()?.name }}
            <span
              class="performer-type"
              *ngIf="getBestPerformer()?.type === 'currency'"
            >
              (Divisa)</span
            >
          </span>
          <span class="performer-change positive">{{
            formatPercentageChange(getBestPerformer()?.change || 0)
          }}</span>
        </div>
        <p class="performer-description">
          Tu favorito con mejor rendimiento hoy
        </p>
      </mat-card-content>
    </mat-card>

    <!-- Peor Performer -->
    <mat-card class="summary-card">
      <mat-card-header>
        <mat-card-title class="trending-down-icon">
          <mat-icon>trending_down</mat-icon>
          Necesita Atención
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div
          class="performer-info"
          *ngIf="getWorstPerformer(); else noPerformer"
        >
          <span class="performer-pair">
            {{ getWorstPerformer()?.name }}
            <span
              class="performer-type"
              *ngIf="getWorstPerformer()?.type === 'currency'"
            >
              (Divisa)</span
            >
          </span>
          <span class="performer-change negative">{{
            formatPercentageChange(getWorstPerformer()?.change || 0)
          }}</span>
        </div>
        <p class="performer-description">
          Revisa las tendencias de este par
        </p>
      </mat-card-content>
    </mat-card>

    <!-- Total Favoritos -->
    <mat-card class="summary-card">
      <mat-card-header>
        <mat-card-title class="star-icon">
          <mat-icon>star</mat-icon>
          Total Favoritos
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="total-info">
          <span class="total-count">{{ getTotalFavorites() }}</span>
          <span class="total-label">favoritos activos</span>
        </div>
        <div class="breakdown-info">
          <small
            >{{ favoritePairs.length }} pares •
            {{ favoriteCurrencies.length }} divisas</small
          >
        </div>
        <p class="total-description">
          Gestiona todos tus favoritos desde aquí
        </p>
      </mat-card-content>
    </mat-card>

    <!-- Promedio de Cambios -->
    <mat-card class="summary-card">
      <mat-card-header>
        <mat-card-title class="analytics-icon">
          <mat-icon>analytics</mat-icon>
          Rendimiento Promedio
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="metric-info">
          <span
            class="metric-value"
            [class.positive]="getAverageChange() > 0"
            [class.negative]="getAverageChange() < 0"
          >
            {{ formatPercentageChange(getAverageChange()) }}
          </span>
          <span class="metric-label">cambio promedio</span>
        </div>
        <div class="metric-details">
          <small
            >{{ getPositiveChangesCount() }} de {{ getTotalFavorites() }} en
            positivo</small
          >
        </div>
        <p class="metric-description">Rendimiento general de tu cartera</p>
      </mat-card-content>
    </mat-card>

    <!-- Estado del Mercado -->
    <mat-card class="summary-card">
      <mat-card-header>
        <mat-card-title class="market-icon">
          <mat-icon [style.color]="getMarketStatus().color">{{
            getMarketStatus().icon
          }}</mat-icon>
          Estado del Mercado
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="market-info">
          <span
            class="market-status"
            [style.color]="getMarketStatus().color"
          >
            {{ getMarketStatus().status }}
          </span>
          <span class="market-time">{{ getMostActiveTime() }}</span>
        </div>
        <div class="volatility-info">
          <small>Volatilidad: {{ getVolatilityLevel() }}</small>
        </div>
        <p class="market-description">Horario y actividad actual</p>
      </mat-card-content>
    </mat-card>

    <!-- Selector de Divisa Base -->
    <mat-card class="summary-card base-currency-card">
      <mat-card-header>
        <mat-card-title class="base-currency-icon">
          <mat-icon>language</mat-icon>
          Divisa Base
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="base-currency-selector">
          <mat-form-field appearance="outline" class="base-currency-field">
            <mat-label>Cambiar divisa base</mat-label>
            <mat-select [formControl]="baseCurrencyControl">
              <mat-option
                *ngFor="let currency of availableBaseCurrencies"
                [value]="currency.code"
              >
                <div class="currency-option">
                  <span class="currency-flag">{{ currency.flag }}</span>
                  <span class="currency-code">{{ currency.code }}</span>
                  <span class="currency-name">{{ currency.name }}</span>
                </div>
              </mat-option>
            </mat-select>
          </mat-form-field>
          <div class="base-currency-info">
            <small
              >Los tipos de cambio se mostrarán desde
              {{ baseCurrency }}</small
            >
          </div>
        </div>
        <p class="base-currency-description">
          Personaliza tu divisa de referencia
        </p>
      </mat-card-content>
    </mat-card>

    <ng-template #noPerformer>
      <div class="no-performer">
        <span>Sin datos suficientes</span>
      </div>
    </ng-template>
  </div>
  </div>
</div>