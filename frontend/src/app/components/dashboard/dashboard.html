<div class="dashboard-container">
  <!-- Header -->
<div class="dashboard-header">
  <div class="title-container">
    <h1 class="main-title">
      <span class="currency-symbol">üíé</span>
      <span class="brand-text">DivisasPro</span>
      <span class="pro-badge">PRO</span>
    </h1>
    <div class="title-tagline">
      <span class="tagline-text">{{ isAuthenticated ? 'Suite Profesional de Trading de Divisas' : 'Plataforma L√≠der en Conversi√≥n de Divisas ‚Ä¢ √önete Gratis' }}</span>
      <div class="live-indicator" *ngIf="isAuthenticated">
        <span class="pulse-dot"></span>
        <span class="live-text">EN VIVO</span>
      </div>
    </div>
  </div>
  
  <!-- Indicadores del mercado en tiempo real -->
<!-- Indicadores del mercado en tiempo real -->
    <div class="market-ticker" *ngIf="isAuthenticated && tickerRates.length > 0">
      <div class="ticker-item" *ngFor="let ticker of tickerRates">
        <span class="ticker-pair">{{ ticker.pair }}</span>
        <span class="ticker-value" [ngClass]="ticker.trend">{{ ticker.rate }}</span>
        <span class="ticker-change">{{ ticker.change }}</span>
      </div>
    </div>

  <div class="content-wrapper">

    <!-- üÜï BANNER DE INFORMACI√ìN PARA USUARIOS NO AUTENTICADOS -->
    <mat-card class="limited-mode-banner" *ngIf="isLimitedMode">
      <mat-card-content>
        <div class="banner-content">
          <div class="banner-icon">
            <mat-icon>info</mat-icon>
          </div>
          <div class="banner-text">
            <h3>Modo de Prueba Activado</h3>
            <p>Est√°s usando DivisasPro en modo limitado. Puedes convertir entre las 8 divisas principales con USD como base.</p>
            <ul class="limitations-list">
              <li>‚Ä¢ Solo 8 divisas principales disponibles ---- ‚Ä¢ Moneda base fija en USD</li>
              <li>‚Ä¢ Sin seguimiento de favoritos ---- ‚Ä¢ Sin an√°lisis t√©cnico ni recomendaciones</li>
            </ul>
          </div>
          <div class="banner-actions">
            <button mat-raised-button color="primary" (click)="router.navigate(['/register'])">
              <mat-icon>person_add</mat-icon>
              Crear Cuenta Gratis
            </button>
            <button mat-raised-button color="primary" (click)="router.navigate(['/login'])">
              <mat-icon>login</mat-icon>
              Iniciar Sesi√≥n
            </button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <div class="update-info-banner">
      <mat-icon>info</mat-icon>
      <div class="update-info-content">
        <span class="update-timestamp">Datos actualizados: {{ ultimaActualizacion }}</span>
        <div class="update-details">
          <small class="update-note"> ‚Ä¢ Tipos de cambio oficiales del Banco Central Europeo</small>
          <small class="update-note"> ‚Ä¢ Tendencias calculadas con datos de 30 d√≠as</small>
          <small class="update-note"> ‚Ä¢ Actualizaci√≥n diaria a las 16:00 CET</small>
        </div>
      </div>
    </div>
    
    <!-- SECCI√ìN 1: CONVERSOR + RESULTADO (2 columnas SIEMPRE visibles) -->
    <div class="converter-result-section">
      <!-- Conversor (Izquierda) - ADAPTADO AL TYPESCRIPT ACTUAL -->
      <mat-card class="currency-converter-card">
        <mat-card-header class="converter-card-header">
          <mat-card-title class="converter-card-title">
            <mat-icon>currency_exchange</mat-icon>
            Conversor de Divisas
          </mat-card-title>
          <mat-card-subtitle class="converter-card-subtitle">
            Conversi√≥n instant√°nea con datos del BCE
          </mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content class="converter-card-content">
          <form class="conversion-form">
            
            <!-- Cantidad a convertir -->
            <div class="amount-input-section">
              <label class="input-label">Cantidad</label>
              <mat-form-field appearance="outline" class="amount-input-field">
                <input matInput 
                       type="number" 
                       [formControl]="cantidad"
                       placeholder="0.00"
                       class="amount-input">
              </mat-form-field>
            </div>

            <!-- Selecci√≥n de divisas -->
            <div class="currency-selector-grid">
              <!-- Divisa origen -->
              <div class="currency-selector-card from-card">
                <span class="selector-label">Desde</span>
                <mat-form-field appearance="outline" class="currency-select-field">
                  <mat-select [formControl]="monedaOrigen" 
                              (selectionChange)="limpiarResultado()">
                    <mat-option *ngFor="let currency of divisas" [value]="currency.code">
                      <div class="currency-option-content">
                        <span class="currency-flag">{{ currency.flag }}</span>
                        <span class="currency-code">{{ currency.code }}</span>
                        <span class="currency-name">{{ currency.name }}</span>
                      </div>
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <!-- Bot√≥n de intercambio -->
              <div class="swap-button-container">
                <button mat-fab 
                        size="mini"
                        color="primary" 
                        (click)="intercambiarDivisas()"
                        class="currency-swap-button"
                        type="button">
                  <mat-icon>swap_horiz</mat-icon>
                </button>
              </div>

              <!-- Divisa destino -->
              <div class="currency-selector-card to-card">
                <span class="selector-label">Hacia</span>
                <mat-form-field appearance="outline" class="currency-select-field">
                  <mat-select [formControl]="monedaDestino" 
                              (selectionChange)="limpiarResultado()">
                    <mat-option *ngFor="let currency of divisas" [value]="currency.code">
                      <div class="currency-option-content">
                        <span class="currency-flag">{{ currency.flag }}</span>
                        <span class="currency-code">{{ currency.code }}</span>
                        <span class="currency-name">{{ currency.name }}</span>
                      </div>
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>

            <!-- Bot√≥n convertir -->
            <div class="convert-button-section">
              <button mat-raised-button 
                      color="primary" 
                      (click)="convert()"
                      class="convert-action-button"
                      [disabled]="cargando || !cantidad.valid || !monedaOrigen.valid || !monedaDestino.valid"
                      type="button">
                <div class="button-content-wrapper">
                  <mat-icon *ngIf="!cargando">calculate</mat-icon>
                  <mat-progress-spinner 
                    *ngIf="cargando" 
                    diameter="18" 
                    mode="indeterminate">
                  </mat-progress-spinner>
                  <span>{{ cargando ? 'Convirtiendo...' : 'Convertir' }}</span>
                </div>
              </button>
            </div>

            <!-- Info del servicio -->
            <div class="service-info-section">
              <div class="info-badge">
                <mat-icon>verified</mat-icon>
                <span>Datos BCE</span>
              </div>
              <div class="info-badge">
                <mat-icon>schedule</mat-icon>
                <span>Tiempo Real</span>
              </div>
            </div>

          </form>
        </mat-card-content>
      </mat-card>

      <!-- Resultado (Derecha) - ADAPTADO AL TYPESCRIPT ACTUAL -->
      <mat-card class="conversion-result-card">
        <mat-card-header class="result-card-header">
          <mat-card-title class="result-card-title">
            <mat-icon>insights</mat-icon>
            {{ resultado ? 'Resultado' : 'Panel de Resultados' }}
          </mat-card-title>
        </mat-card-header>

        <mat-card-content class="result-card-content">
          
          <!-- Mostrar resultado si existe -->
          <div class="conversion-result-display" *ngIf="resultado">
            
            <!-- Resultado principal -->
            <div class="main-result-section">
              <div class="conversion-equation">
                <span class="original-amount">{{ cantidad.value | number:'1.0-2' }} {{ monedaOrigen.value }}</span>
                <mat-icon class="equals-sign">keyboard_double_arrow_right</mat-icon>
              </div>
              
              <div class="converted-amount-display">
                <span class="result-number">{{ resultado.valorConvertido | number:'1.2-2' }}</span>
                <span class="result-currency">{{ monedaDestino.value }}</span>
              </div>

              <div class="exchange-rate-info">
                <div class="rate-display-box">
                  <mat-icon>info_outline</mat-icon>
                  <span>1 {{ monedaOrigen.value }} = {{ resultado.tasaCambio | number:'1.4-4' }} {{ monedaDestino.value }}</span>
                </div>
              </div>
            </div>

            <!-- Informaci√≥n adicional en grid -->
            <div class="result-details-grid">
              <div class="detail-item">
                <mat-icon class="detail-icon">event</mat-icon>
                <div class="detail-content">
                  <span class="detail-label">Fecha</span>
                  <span class="detail-value">{{ formatearFecha(resultado.timestamp) }}</span>
                </div>
              </div>

              <div class="detail-item">
                <mat-icon class="detail-icon">swap_horiz</mat-icon>
                <div class="detail-content">
                  <span class="detail-label">Inverso</span>
                  <span class="detail-value">1 {{ monedaDestino.value }} = {{ obtenerTasaInversa() | number:'1.4-4' }} {{ monedaOrigen.value }}</span>
                </div>
              </div>

              <div class="detail-item">
                <mat-icon class="detail-icon trending" [ngClass]="{
                  'trend-up': resultado.tasaCambio > 1,
                  'trend-down': resultado.tasaCambio < 1,
                  'trend-neutral': resultado.tasaCambio === 1
                }">
                  {{ resultado.tasaCambio > 1 ? 'trending_up' : resultado.tasaCambio < 1 ? 'trending_down' : 'trending_flat' }}
                </mat-icon>
                <div class="detail-content">
                  <span class="detail-label">Tendencia</span>
                  <span class="detail-value" [ngClass]="{
                    'strong': resultado.tasaCambio > 1,
                    'weak': resultado.tasaCambio < 1,
                    'neutral': resultado.tasaCambio === 1
                  }">
                    {{ resultado.tasaCambio > 1 ? 'Fuerte' : resultado.tasaCambio < 1 ? 'D√©bil' : 'Neutral' }}
                  </span>
                </div>
              </div>

              <div class="detail-item">
                <mat-icon class="detail-icon">precision_manufacturing</mat-icon>
                <div class="detail-content">
                  <span class="detail-label">Precisi√≥n</span>
                  <span class="detail-value">Alta (BCE)</span>
                </div>
              </div>
            </div>

            <!-- Acciones del resultado -->
            <div class="result-actions-section">
              <button mat-raised-button 
                      color="primary" 
                      (click)="intercambiarDivisas()"
                      class="result-action-btn">
                <mat-icon>swap_vert</mat-icon>
                Intercambiar
              </button>
              
              <button mat-stroked-button 
                      color="accent" 
                      (click)="copiarResultado()"
                      class="result-action-btn">
                <mat-icon>content_copy</mat-icon>
                Copiar
              </button>
            </div>
          </div>

          <!-- Mensaje de bienvenida si no hay resultado -->
          <div class="welcome-message-display" *ngIf="!resultado">
            <div class="welcome-icon-container">
              <mat-icon class="welcome-icon">calculate</mat-icon>
            </div>
            
            <div class="welcome-text-content">
              <h3 class="welcome-title">¬°Bienvenido al Conversor!</h3>
              
              <div class="instruction-steps">
                <div class="instruction-step">
                  <mat-icon class="step-icon">looks_one</mat-icon>
                  <span class="step-text">Introduce la <strong>cantidad</strong></span>
                </div>
                <div class="instruction-step">
                  <mat-icon class="step-icon">looks_two</mat-icon>
                  <span class="step-text">Selecciona las <strong>divisas</strong></span>
                </div>
                <div class="instruction-step">
                  <mat-icon class="step-icon">looks_3</mat-icon>
                  <span class="step-text">Haz clic en <strong>"Convertir"</strong></span>
                </div>
              </div>

              <div class="welcome-features">
                <div class="feature-chip">
                  <mat-icon>verified</mat-icon>
                  <span>Datos BCE</span>
                </div>
                <div class="feature-chip">
                  <mat-icon>speed</mat-icon>
                  <span>Instant√°neo</span>
                </div>
              </div>

              <div class="quick-tip">
                <mat-icon>lightbulb</mat-icon>
                <span>Usa el bot√≥n de intercambio para invertir las divisas r√°pidamente</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- SECCI√ìN 2: ANALYTICS (4 cards horizontales) -->
    <mat-card class="analytics-compact" *ngIf="isAuthenticated && userStats">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>analytics</mat-icon>
          Tus Estad√≠sticas
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <div class="stats-grid-horizontal">
          <!-- Total Conversiones -->
          <div class="stat-card-compact conversions">
            <mat-icon>swap_horiz</mat-icon>
            <div class="stat-info">
              <span class="stat-number">{{ userStats.totalConversions }}</span>
              <span class="stat-label">Conversiones</span>
              <span class="stat-trend positive" *ngIf="userStats.weeklyTrend.includes('+')">{{ userStats.weeklyTrend }}</span>
            </div>
          </div>

          <!-- Volumen Total -->
          <div class="stat-card-compact volume">
            <mat-icon>attach_money</mat-icon>
            <div class="stat-info">
              <span class="stat-number">{{ formatVolume(userStats.totalVolume) }}</span>
              <span class="stat-label">Volumen (datos reales)</span>
              <small class="data-source">Basado en tipos BCE</small>
            </div>
          </div>

          <!-- Par Favorito -->
          <div class="stat-card-compact pair">
            <mat-icon>favorite</mat-icon>
            <div class="stat-info">
              <span class="stat-number">{{ userStats.topPair }}</span>
              <span class="stat-label">Top Par</span>
            </div>
          </div>

          <!-- Total Alertas -->
          <div class="stat-card-compact alerts">
            <mat-icon>notifications</mat-icon>
            <div class="stat-info">
              <span class="stat-number">{{ userStats.totalAlerts }}</span>
              <span class="stat-label">Alertas</span>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- SECCI√ìN 3: TENDENCIAS FAVORITOS (Compacta) -->
    <mat-card class="trends-compact" *ngIf="isAuthenticated && favoriteTrends?.trends?.length > 0">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>trending_up</mat-icon>
          Tendencias (7 d√≠as)
        </mat-card-title>
        <mat-card-subtitle>Tus pares favoritos</mat-card-subtitle>
      </mat-card-header>
      
      <mat-card-content>
        <div class="trends-horizontal">
          <div class="trend-item-compact" *ngFor="let trend of favoriteTrends.trends">
            <div class="trend-pair-compact">
              <span class="pair-name">{{ trend.pair }}</span>
              <span class="current-rate">{{ trend.currentRate }}</span>
            </div>
            
            <div class="trend-change-compact" [ngClass]="{
              'trend-up': trend.trend === 'up',
              'trend-down': trend.trend === 'down',
              'trend-stable': trend.trend === 'stable'
            }">
              <mat-icon *ngIf="trend.trend === 'up'">trending_up</mat-icon>
              <mat-icon *ngIf="trend.trend === 'down'">trending_down</mat-icon>
              <mat-icon *ngIf="trend.trend === 'stable'">trending_flat</mat-icon>
              {{ trend.change }}
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- SECCI√ìN 4: Mercado de Divisas -->
    <mat-card class="rates-section-improved">
      <mat-card-header>
        <div class="rates-header">
          <div class="rates-title">
            <mat-card-title>  
              Mercado de Divisas 
              <mat-icon>trending_up</mat-icon>
            </mat-card-title>
            <mat-card-subtitle>
              Base: <strong>{{ monedaBase.value }}</strong> ‚Ä¢ Actualizado <strong>{{ ultimaActualizacion }}</strong>
              <span *ngIf="isLimitedMode" class="limited-indicator"> ‚Ä¢ Solo 8 divisas principales</span>
            </mat-card-subtitle>
          </div>
          
          <!-- ‚úÖ CONTROLES: Filtro + Selector -->
          <div class="rates-controls">
            <!-- üÜï FILTRO DE DIVISAS (solo usuarios registrados) -->
            <div class="currency-filter-section" *ngIf="isAuthenticated">
              <div class="filter-header">
                <mat-icon class="filter-icon">search</mat-icon>
                <span class="filter-title">Buscar Divisa</span>
              </div>
              
              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Filtrar por c√≥digo o nombre</mat-label>
                <input matInput 
                       [formControl]="currencyFilter"
                       placeholder="USD, Euro, D√≥lar..."
                       class="filter-input">
                <mat-icon matSuffix>search</mat-icon>
              </mat-form-field>
              
              <div class="filter-info">
                <mat-icon>info_outline</mat-icon>
                <span>Busca entre {{ tiposCambio.length }} divisas disponibles</span>
              </div>
            </div>

            <!-- SELECTOR DE MONEDA BASE -->
            <div class="currency-base-selector-modern" 
                 [class.disabled]="isLimitedMode">
              <div class="selector-header">
                <mat-icon class="selector-icon">settings</mat-icon>
                <span class="selector-title">Moneda Base</span>
              </div>
              
              <mat-form-field appearance="outline" class="base-select-field">
                <mat-label>Seleccionar base</mat-label>
                <mat-select [formControl]="monedaBase" 
                            (selectionChange)="cambiarMonedaBase()"
                            [disabled]="isLimitedMode"
                            class="base-select">
                  <mat-option *ngFor="let divisa of getDivisasDisponibles()" 
                              [value]="divisa.code"
                              class="base-option">
                    <div class="option-content">
                      <span class="option-flag">{{ divisa.flag }}</span>
                      <span class="option-code">{{ divisa.code }}</span>
                      <span class="option-name">{{ divisa.name }}</span>
                    </div>
                  </mat-option>
                </mat-select>
              </mat-form-field>
              
              <div class="selector-info">
                <mat-icon>info_outline</mat-icon>
                <span>Todas las tasas se muestran relativas a esta moneda</span>
              </div>
            </div>
          </div>
        </div>
      </mat-card-header>
      
      <mat-card-content>
        <!-- Grid de Cards de Divisas -->
        <div class="rates-grid" *ngIf="(isAuthenticated ? filteredTiposCambio : tiposCambio).length > 0">
          <div class="rate-card"
               *ngFor="let rate of (isAuthenticated ? filteredTiposCambio : tiposCambio)"
               [ngClass]="{
                 'trending-up': getTendenciaReal(rate.code) > 0 && !rate.isBaseCurrency,
                 'trending-down': getTendenciaReal(rate.code) < 0 && !rate.isBaseCurrency,
                 'trending-stable': getTendenciaReal(rate.code) === 0 || rate.isBaseCurrency,
                 'base-currency': rate.isBaseCurrency
               }">
            <div class="rate-content" [class.updating]="cargandoTabla">
              <!-- Header de la Card -->
              <div class="rate-header">
                <div class="currency-info">
                  <span class="flag">{{ rate.flag }}</span>
                  <div class="currency-details">
                    <strong class="currency-code">{{ rate.code }}</strong>
                    <small class="currency-name">{{ rate.name }}</small>
                  </div>
                </div>
                
                <!-- ‚úÖ ICONO ESPECIAL PARA MONEDA BASE -->
                <div class="trend-indicator" 
                     *ngIf="!rate.isBaseCurrency"
                     [ngClass]="{
                       'trend-up': rate.tendencia > 0,
                       'trend-down': rate.tendencia < 0, 
                       'trend-stable': rate.tendencia === 0
                     }">
                  <mat-icon>
                    {{ rate.tendencia > 0 ? 'trending_up' : rate.tendencia < 0 ? 'trending_down' : 'trending_flat' }}
                  </mat-icon>
                </div>
              </div>

              <!-- Tasa Principal -->
              <div class="rate-main">
                <!-- ‚úÖ NUEVA L√çNEA: Etiqueta "1 USD =" -->
                <span class="base-currency-label" *ngIf="!rate.isBaseCurrency">
                  1 {{ monedaBase.value }} =
                </span>
                
                <span class="rate-value" [class.updating]="cargandoTabla">
                  {{ rate.isBaseCurrency ? '1.0000' : (rate.rate | number:'1.2-2') }}
                </span>
                <span class="rate-label">{{ rate.code }}</span>
              </div>

              <!-- Cambio y Porcentaje -->
              <div class="rate-change">
                <span class="change-percent" [ngClass]="{
                    'positive': rate.tendencia > 0 && !rate.isBaseCurrency,
                    'negative': rate.tendencia < 0 && !rate.isBaseCurrency,
                    'neutral': rate.isBaseCurrency
                }">
                  {{ rate.isBaseCurrency ? 'REFERENCIA' : (rate.tendencia > 0 ? '+' : '') + rate.cambio + '%' }}
                  <small class="trend-period" *ngIf="!rate.isBaseCurrency">(30 d√≠as)</small>
                </span>
                <div class="trend-details">
                  <small class="change-label">{{ rate.isBaseCurrency ? 'Moneda base seleccionada' : 'Datos hist√≥ricos BCE' }}</small>
                </div>
              </div>

              <!-- Informaci√≥n Adicional -->
              <div class="rate-extra">
                <div class="inverse-rate">
                  <mat-icon>swap_horiz</mat-icon>
                  <span>1 {{ rate.code }} = {{ rate.isBaseCurrency ? '1.0000' : ((1/rate.rate) | number:'1.2-2') }} {{ monedaBase.value }}</span>
                </div>
              </div>

              <!-- ‚úÖ ACCIONES ESPECIALES PARA BASE -->
              <div class="rate-actions-container">
                <button 
                  *ngIf="!rate.isBaseCurrency"
                  mat-raised-button 
                  color="primary" 
                  (click)="convertirA(rate.code)"
                  class="action-button">
                  Convertir a {{ rate.code }}
                </button>
                
                <button 
                  *ngIf="rate.isBaseCurrency"
                  mat-raised-button 
                  color="accent" 
                  class="action-button base-action"
                  disabled>
                  <mat-icon>home</mat-icon>
                  Base Actual
                </button>

                <button 
                  mat-raised-button 
                  [color]="isAuthenticated ? 'accent' : 'warn'"
                  (click)="handleDetalles(rate.code)"
                  class="action-button">
                  <mat-icon>{{ isAuthenticated ? 'analytics' : 'lock' }}</mat-icon>
                  {{ isAuthenticated ? 'Ver Detalles' : 'An√°lisis Premium' }}
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- üÜï MENSAJE CUANDO NO HAY RESULTADOS DE FILTRO -->
        <div class="no-filter-results" *ngIf="isAuthenticated && filteredTiposCambio.length === 0 && tiposCambio.length > 0 && currencyFilter.value?.trim()">
          <mat-icon>search_off</mat-icon>
          <h3>No se encontraron divisas</h3>
          <p>No hay divisas que coincidan con "<strong>{{ currencyFilter.value }}</strong>"</p>
          <div class="filter-suggestions">
            <p><strong>Prueba buscando:</strong></p>
            <ul>
              <li>C√≥digo de divisa: <em>USD, EUR, GBP, JPY</em></li>
              <li>Nombre completo: <em>D√≥lar, Euro, Libra</em></li>
              <li>Pa√≠s/regi√≥n: <em>Estadounidense, Europeo, Brit√°nico</em></li>
            </ul>
          </div>
          <button mat-raised-button color="primary" (click)="currencyFilter.setValue('')">
            <mat-icon>clear</mat-icon>
            Limpiar filtro
          </button>
        </div>

        <!-- Estado Vac√≠o -->
        <div class="empty-rates" *ngIf="!cargandoTabla && tiposCambio.length === 0">
          <mat-icon>error_outline</mat-icon>
          <h3>No se pudieron cargar los tipos de cambio</h3>
          <p>Verifica tu conexi√≥n e int√©ntalo de nuevo</p>
          <button mat-raised-button color="primary" (click)="cargarTiposCambio()">
            <mat-icon>refresh</mat-icon>
            Reintentar
          </button>
        </div>
      </mat-card-content>
    </mat-card>

  </div>

  <!-- MODAL PARA DETALLES DE DIVISA -->
  <div class="currency-detail-modal" *ngIf="showCurrencyDetail" (click)="closeCurrencyModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      
      <!-- Header del Modal (visible para todos) -->
      <div class="modal-header">
        <div class="currency-header">
          <span class="currency-flag-large">{{ selectedCurrency?.flag }}</span>
          <div class="currency-title">
            <h2>{{ selectedCurrency?.name }}</h2>
            <span class="currency-code-subtitle">{{ selectedCurrency?.code }}</span>
          </div>
        </div>
        
        <button mat-icon-button (click)="closeCurrencyModal()" class="close-button">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <!-- Contenido del Modal -->
      <div class="modal-body">
        
        <!-- Informaci√≥n b√°sica (visible para todos) -->
        <div class="currency-main-info">
          <div class="info-card primary">
            <mat-icon>trending_up</mat-icon>
            <div class="info-content">
              <span class="info-label">Tasa Actual</span>
              <span class="info-value">{{ selectedRate?.rate | number:'1.4-6' }}</span>
              <span class="info-description">1 {{ monedaBase.value }} = {{ selectedRate?.rate | number:'1.4-6' }} {{ selectedCurrency?.code }}</span>
            </div>
          </div>

          <div class="info-card secondary">
            <mat-icon>swap_horiz</mat-icon>
            <div class="info-content">
              <span class="info-label">Tasa Inversa</span>
              <span class="info-value">{{ getInverseRate() | number:'1.4-6' }}</span>
              <span class="info-description">1 {{ selectedCurrency?.code }} = {{ getInverseRate() | number:'1.4-6' }} {{ monedaBase.value }}</span>
            </div>
          </div>
        </div>

        <!-- Contenido Premium -->
        <div class="analysis-recommendation-wrapper" *ngIf="isAuthenticated">
          <!-- Columna izquierda: An√°lisis T√©cnico -->
          <div class="analysis-column">
            <div class="currency-analysis">
              <div class="analysis-card">
                <div class="analysis-header">
                  
                  <h3>An√°lisis T√©cnico</h3>

                  <mat-icon [ngClass]="{
                    'trending-up': getTrendDirection() === 'up',
                    'trending-down': getTrendDirection() === 'down',
                    'trending-flat': getTrendDirection() === 'stable'
                  }">
                    {{ getTrendIcon() }}
                  </mat-icon>
                </div>

                <div class="trend-info">
                  <div class="trend-item" matTooltip="Calculado con datos reales del BCE">
                    <span class="trend-label">Tendencia (30 d√≠as):</span>
                    <div class="trend-value-container">
                      <div class="trend-icons">
                        <mat-icon *ngIf="tendenciaReal !== null && tendenciaReal > 0" color="primary">trending_up</mat-icon>
                        <mat-icon *ngIf="tendenciaReal !== null && tendenciaReal < 0" color="warn">trending_down</mat-icon>
                        <mat-icon *ngIf="tendenciaReal === null || tendenciaReal === 0">trending_flat</mat-icon>
                      </div>
                      <span *ngIf="tendenciaReal !== null; else cargandoTendencia" class="trend-percentage">
                        {{ tendenciaReal | number:'1.2-2' }}%
                      </span>
                      <ng-template #cargandoTendencia>
                        <mat-progress-spinner diameter="18" mode="indeterminate"></mat-progress-spinner>
                      </ng-template>
                    </div>
                  </div>

                  <div class="trend-item">
                    <span class="trend-label">Volatilidad:</span>
                    <span *ngIf="volatilidadReal !== null; else cargandoVol">
                      {{ volatilidadReal | number:'1.4-4' }}
                    </span>
                    <ng-template #cargandoVol>
                      <mat-progress-spinner diameter="18" mode="indeterminate"></mat-progress-spinner>
                    </ng-template>
                  </div>

                  <div class="trend-item">
                    <span class="trend-label">Fuerza:</span>
                    <span class="trend-value" [ngClass]="{
                      'positive': (selectedRate?.rate || 1) > 1,
                      'negative': (selectedRate?.rate || 1) < 1,
                      'neutral': (selectedRate?.rate || 1) === 1
                    }">
                      {{ (selectedRate?.rate || 1) > 1 ? 'Fuerte vs ' + monedaBase.value : (selectedRate?.rate || 1) < 1 ? 'D√©bil vs ' + monedaBase.value : 'Equilibrado' }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Columna derecha: Recomendaci√≥n -->
          <div class="recommendation-column">
            @if (recomendacionReal) {
              <div class="recommendation-horizontal-card" [ngClass]="recomendacionReal.accion.toLowerCase()">
                <div class="horizontal-icon-area" [ngClass]="recomendacionReal.accion.toLowerCase()">
                  <i class="fa-solid"
                     [ngClass]="{
                       'fa-cart-shopping': recomendacionReal.accion === 'COMPRAR',
                       'fa-tag': recomendacionReal.accion === 'VENDER',
                       'fa-hand': recomendacionReal.accion === 'MANTENER',
                       'fa-hourglass-half': recomendacionReal.accion === 'ESPERAR'
                     }"
                     style="font-size: 3.2rem; color: #fff;">
                  </i>
                </div>
                <div class="horizontal-tip-content">
                  <div class="horizontal-tip-title" [ngClass]="recomendacionReal.accion.toLowerCase()">
                    {{ recomendacionReal.accion }}
                  </div>
                  <div class="horizontal-tip-message">
                    {{ recomendacionReal.mensaje }}
                  </div>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- NUEVA RECOMENDACI√ìN (TIP) -->
      

        <!-- Breakdown de se√±ales de la recomendaci√≥n -->
        <div class="recommendation-breakdown" *ngIf="getRecommendationBreakdown().length">
          <h4>¬øPor qu√© esta recomendaci√≥n?</h4>
          <div class="breakdown-list">
            <div class="breakdown-item"
                 *ngFor="let ind of getRecommendationBreakdown()"
                 [ngClass]="{
                   'breakdown-positive': ind.positive,
                   'breakdown-negative': ind.negative,
                   'breakdown-warn': !ind.positive && !ind.negative
                 }">
              <mat-icon *ngIf="ind.positive">check_circle</mat-icon>
              <mat-icon *ngIf="ind.negative">cancel</mat-icon>
              <mat-icon *ngIf="!ind.positive && !ind.negative">info</mat-icon>
              <span class="breakdown-label">{{ ind.label }}:</span>
              <span class="breakdown-value">{{ ind.value }}</span>
              <span class="breakdown-desc">{{ ind.descripcion }}</span>
            </div>
          </div>
        </div>

        <!-- NUEVO: Indicadores Adicionales (RSI, SMA) -->
        <div class="indicator-info">
          <div>
            <b>RSI (14 d√≠as):</b> {{ rsi !== null ? rsi : '‚Äî' }}
            <span *ngIf="rsi !== null && rsi < 30" class="rsi-label sobreventa">(Sobreventa)</span>
            <span *ngIf="rsi !== null && rsi > 70" class="rsi-label sobrecompra">(Sobrecompra)</span>
            <span *ngIf="rsi !== null && rsi >= 30 && rsi <= 70" class="rsi-label neutro">(Neutro)</span>
          </div>
          <div>
            <b>SMA (7 d√≠as):</b> {{ sma !== null ? sma : '‚Äî' }}
            <span *ngIf="sma !== null && selectedRate?.rate > sma" class="sma-label sma-up">(Por encima de la media)</span>
            <span *ngIf="sma !== null && selectedRate?.rate < sma" class="sma-label sma-down">(Por debajo de la media)</span>
            <span *ngIf="sma !== null && selectedRate?.rate === sma" class="sma-label neutro">(En la media)</span>
          </div>
          <div>
            <b>Tendencia (30 d√≠as):</b> {{ tendenciaReal !== null ? (tendenciaReal | number:'1.2-2') + '%' : '‚Äî' }}
          </div>
          <div>
            <b>Volatilidad (30 d√≠as):</b> {{ volatilidadReal !== null ? (volatilidadReal | number:'1.4-4') : '‚Äî' }}
          </div>
        </div>

        <!-- NUEVA SECCI√ìN: Explicaci√≥n de la Recomendaci√≥n -->
        <div class="recommendation-explanation">
          <b>¬øC√≥mo se calcula la recomendaci√≥n?</b>
          <p>
            Analizamos indicadores t√©cnicos reales:<br><br>
            - <b>RSI:</b> mide sobrecompra/sobreventa.<br>
            - <b>SMA:</b> compara el precio actual con la media de 7 d√≠as.<br>
            - <b>Tendencia:</b> direcci√≥n del precio en 30 d√≠as.<br>
            - <b>Volatilidad:</b> variaci√≥n de precios.<br><br>
            Si la mayor√≠a de se√±ales son positivas, recomendamos <b>COMPRAR</b>.<br> Si son negativas, <b>VENDER</b>.<br> Si no hay se√±ales claras, <b>MANTENER</b> o <b>ESPERAR</b>.
          </p>
        </div>
      </div>

      <!-- Acciones del Modal -->
      <div class="modal-actions">
        <button mat-raised-button color="primary" (click)="convertirA(selectedCurrency?.code || '')">
          <mat-icon>currency_exchange</mat-icon>
          Convertir a {{ selectedCurrency?.code }}
        </button>
        
        <button mat-stroked-button 
                color="accent" 
                (click)="addToFavorites()"
                *ngIf="isAuthenticated">
          <mat-icon>favorite_border</mat-icon>
          A√±adir a Favoritos
        </button>

        <!-- Mostrar bot√≥n de registro si NO est√° autenticado -->
        <button mat-stroked-button 
                color="primary" 
                (click)="goToRegister()"
                *ngIf="!isAuthenticated">
          <mat-icon>person_add</mat-icon>
          Reg√≠strate para a√±adir a Favoritos
        </button>
        
        <button mat-stroked-button (click)="closeCurrencyModal()">
          <mat-icon>close</mat-icon>
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL PREMIUM PARA USUARIOS NO REGISTRADOS -->
  <div class="currency-detail-modal premium" 
       *ngIf="showPremiumModal" 
       (click)="onPremiumModalBackground($event)">
    
    <div class="modal-content simple-premium-modal" (click)="$event.stopPropagation()">
      
      <!-- Bot√≥n de cerrar -->
      <button mat-icon-button (click)="closePremiumModal()" class="close-button">
        <mat-icon>close</mat-icon>
      </button>

      <!-- Banner principal -->
      <div class="premium-register-banner">
        
        <!-- Icono del candado mejorado -->
        <mat-icon class="premium-lock-icon">lock</mat-icon>
        
        <!-- Header del contenido -->
        <div class="premium-header-content">
          <h2>üåü An√°lisis Premium de {{ premiumCurrency?.code }}</h2>
          <p>Desbloquea an√°lisis t√©cnico avanzado y recomendaciones de inversi√≥n personalizadas</p>
        </div>

        <!-- Lista de caracter√≠sticas -->
        <ul class="premium-features">
          <li>
            <mat-icon>trending_up</mat-icon>
            An√°lisis t√©cnico en tiempo real
          </li>
          <li>
            <mat-icon>insights</mat-icon>
            Indicadores RSI, SMA y volatilidad
          </li>
          <li>
            <mat-icon>psychology</mat-icon>
            Recomendaciones de inversi√≥n IA
          </li>
          <li>
            <mat-icon>history</mat-icon>
            Hist√≥ricos de 30 d√≠as
          </li>
          <li>
            <mat-icon>favorite</mat-icon>
            Seguimiento de favoritos
          </li>
          <li>
            <mat-icon>notifications</mat-icon>
            Alertas personalizadas
          </li>
        </ul>

        <!-- Botones de acci√≥n -->
        <div class="premium-actions">
          <button mat-raised-button 
                  color="primary" 
                  (click)="goToRegister()">
            <mat-icon>person_add</mat-icon>
            Crear Cuenta Gratis
          </button>
          
          <button mat-stroked-button 
                  color="primary"
                  (click)="goToLogin()">
            <mat-icon>login</mat-icon>
            Ya tengo cuenta
          </button>
        </div>

      </div>
    </div>
  </div>
</div>
