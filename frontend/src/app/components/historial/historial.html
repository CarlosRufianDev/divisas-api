<div class="historial-container">
  <div class="content-wrapper">
    <!-- Header con título -->
    <div class="historial-header">
      <div class="header-content">
        <div class="header-info">
          <div class="header-text">
            <h1>Historial de Conversiones</h1>
            <p>Todas tus conversiones de divisas organizadas y filtradas profesionalmente</p>
          </div>
        </div>
        <div class="header-stats" *ngIf="conversions.length > 0">
          <div class="stat-item">
            <span class="stat-number">{{ conversions.length }}</span>
            <span class="stat-label">Conversiones</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">{{ pagination.total }}</span>
            <span class="stat-label">Total</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros y resultados juntos -->
    <mat-card class="filters-and-results-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>filter_list</mat-icon>
          Filtros de Búsqueda
        </mat-card-title>
        <div class="header-actions">
          <button
            mat-button
            class="clear-all-btn"
            (click)="clearAllHistory()"
            [disabled]="loading || conversions.length === 0"
          >
            <mat-icon>delete_sweep</mat-icon>
            Limpiar Todo
          </button>
        </div>
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="filtersForm" class="filters-form">
          <div class="filters-grid">
            <mat-form-field
              appearance="outline"
              class="filter-field"
              data-field="from"
              floatLabel="always"
            >
              <mat-label>Divisa origen</mat-label>
              <mat-select
                formControlName="from"
                (selectionChange)="onFromFilterChange()"
              >
                <mat-option value="">Todas las divisas</mat-option>
                <mat-option
                  *ngFor="let currency of getFilteredFromCurrencies()"
                  [value]="currency.code"
                >
                  {{ currency.flag }} {{ currency.code }} -
                  {{ currency.name }}
                </mat-option>
              </mat-select>
              <mat-icon matSuffix>currency_exchange</mat-icon>
            </mat-form-field>

            <mat-form-field
              appearance="outline"
              class="filter-field"
              data-field="to"
              floatLabel="always"
            >
              <mat-label>Divisa destino</mat-label>
              <mat-select
                formControlName="to"
                (selectionChange)="onToFilterChange()"
              >
                <mat-option value="">Todas las divisas</mat-option>
                <mat-option
                  *ngFor="let currency of getFilteredToCurrencies()"
                  [value]="currency.code"
                >
                  {{ currency.flag }} {{ currency.code }} -
                  {{ currency.name }}
                </mat-option>
              </mat-select>
              <mat-icon matSuffix>currency_exchange</mat-icon>
            </mat-form-field>

            <mat-form-field
              appearance="outline"
              class="filter-field"
              data-field="minAmount"
              floatLabel="always"
            >
              <mat-label>Cantidad mínima</mat-label>
              <input
                matInput
                type="number"
                formControlName="minAmount"
                min="0"
                step="0.01"
                placeholder="Ej: 100.00"
              />
              <mat-icon matSuffix>trending_up</mat-icon>
            </mat-form-field>

            <mat-form-field
              appearance="outline"
              class="filter-field"
              data-field="maxAmount"
              floatLabel="always"
            >
              <mat-label>Cantidad máxima</mat-label>
              <input
                matInput
                type="number"
                formControlName="maxAmount"
                min="0"
                step="0.01"
                placeholder="Ej: 10000.00"
              />
              <mat-icon matSuffix>trending_down</mat-icon>
            </mat-form-field>
          </div>

          <div class="filters-actions">
            <button
              mat-raised-button
              class="apply-filters-btn"
              (click)="applyFilters()"
              [disabled]="loading"
            >
              <mat-icon>search</mat-icon>
              Aplicar Filtros
            </button>
            <button
              mat-button
              class="clear-filters-btn"
              (click)="clearFilters()"
              [disabled]="loading"
            >
              <mat-icon>clear</mat-icon>
              Limpiar Filtros
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Loading -->
    <div *ngIf="loading" class="loading-container">
      <mat-spinner diameter="60"></mat-spinner>
      <p>Cargando historial de conversiones...</p>
    </div>

    <!-- Sin datos -->
    <mat-card
      *ngIf="!loading && conversions.length === 0"
      class="empty-state"
    >
      <mat-card-content>
        <div class="empty-content">
          <mat-icon class="empty-icon">history</mat-icon>
          <h2>No hay conversiones registradas</h2>
          <p>
            Aún no has realizado ninguna conversión de divisas.<br />
            ¡Empieza a convertir para ver tu historial aquí!
          </p>
          <button mat-raised-button color="primary" routerLink="/dashboard">
            <mat-icon>currency_exchange</mat-icon>
            Ir al Conversor
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Tabla de historial -->
    <mat-card
      *ngIf="!loading && conversions.length > 0"
      class="history-table-card"
    >
      <mat-card-header>
        <mat-card-title>
          <mat-icon>list_alt</mat-icon>
          Resultados del Historial ({{ pagination.total }} total)
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div class="table-container">
          <table mat-table [dataSource]="conversions" class="history-table">
            <!-- Fecha -->
            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef>
                <mat-icon>schedule</mat-icon> Fecha y Hora
              </th>
              <td mat-cell *matCellDef="let conversion">
                <div class="date-cell">
                  <span class="date">{{
                    formatDate(conversion.createdAt)
                  }}</span>
                  <span class="time">{{
                    formatTime(conversion.createdAt)
                  }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Conversión -->
            <ng-container matColumnDef="conversion">
              <th mat-header-cell *matHeaderCellDef>
                <mat-icon>swap_horiz</mat-icon> Conversión Realizada
              </th>
              <td mat-cell *matCellDef="let conversion">
                <div class="conversion-cell">
                  <span class="conversion-text">
                    {{ conversion.amount | number : '1.2-2' }}
                    {{ conversion.from }}
                    <mat-icon class="arrow-icon">arrow_forward</mat-icon>
                    {{ conversion.result | number : '1.2-2' }}
                    {{ conversion.to }}
                  </span>
                  <span class="rate">
                    Tasa aplicada: {{ conversion.rate | number : '1.4-4' }}
                  </span>
                </div>
              </td>
            </ng-container>

            <!-- Acciones -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>
                <mat-icon>settings</mat-icon> Acciones
              </th>
              <td mat-cell *matCellDef="let conversion">
                <button
                  mat-icon-button
                  color="warn"
                  (click)="deleteConversion(conversion._id)"
                  [disabled]="loading"
                  matTooltip="Eliminar conversión"
                  matTooltipPosition="above"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: displayedColumns"
            ></tr>
          </table>
        </div>

        <!-- Paginación -->
        <mat-paginator
          [length]="pagination.total"
          [pageSize]="pagination.limit"
          [pageIndex]="pagination.page - 1"
          [pageSizeOptions]="[5, 10, 20, 50]"
          (page)="onPageChange($event)"
          showFirstLastButtons
        >
        </mat-paginator>
      </mat-card-content>
    </mat-card>
  </div>
</div>